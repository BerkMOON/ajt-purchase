# 奥吉通集团配件集采系统 - 数据库设计文档（询价与报价模块）

**版本：** 1.0 **日期：** 2025-11-21 **文档状态：** 正式版

---

## 1. 概述

本文档定义了询价与报价模块的核心数据表结构，包括询价单主表、询价单明细表、供应商报价表和供应商报价明细表。

### 1.1 设计原则

- **主键策略**：使用自增 ID 作为数据库主键，业务单号作为业务主键
- **软删除**：采用 `is_deleted` 字段实现软删除
- **时间戳**：统一使用 `ctime` 和 `mtime` 记录创建和更新时间
- **状态管理**：询价和报价状态采用整型枚举
- **数据类型**：金额使用 `decimal(10,2)`，时间使用 `datetime`
- **冗余字段**：为提升查询性能，适当冗余存储关联表的关键字段

### 1.2 命名规范

- 表名：`tb_` + 业务名称，使用下划线分隔单词
- 字段名：使用小写字母和下划线，语义清晰
- 索引名：`idx_` + 表名简称 + 字段名
- 唯一索引：`uk_` + 表名简称 + 字段名

### 1.3 业务说明

**询价流程：**

1. 采购单审核通过后，系统自动根据采购单中的商品，查找能提供这些商品的供应商
2. 为每个供应商生成独立的询价单（只包含该供应商能供应的商品）
3. 系统自动发送询价通知给供应商

**报价流程：**

1. 供应商登录外部门户，查看询价单详情
2. 供应商对询价单中的每个商品进行报价（单价、预计交货期、备注）
3. 供应商提交报价后，报价状态变为"已报价"
4. 超过询价截止时间未报价的，状态自动变为"未报价"

**比价与选择：**

1. 采购员查看所有供应商的报价
2. 系统自动标识最低价供应商
3. 采购员选择供应商后，报价状态变为"已选中"
4. 如果报价超过采购均价一定比例，触发价格审批流程

---

## 2. 询价单主表

### 2.1 表名

`tb_inquiry`

### 2.2 表说明

存储系统向供应商发送的询价单信息。一个采购单可能对应多个询价单（每个供应商一个），每个询价单只包含该供应商能供应的商品。

### 2.3 表结构

| 字段名 | 数据类型 | 是否为空 | 默认值 | 说明 |
| --- | --- | --- | --- | --- |
| id | bigint | NOT NULL | 自增 | 主键 ID |
| inquiry_no | bigint | NOT NULL | 0 | 询价单号（业务主键，使用 ID 生成算法生成） |
| order_id | bigint | NOT NULL | 0 | 采购单主表 ID |
| order_no | bigint | NOT NULL | 0 | 采购单号（冗余字段，便于查询） |
| supplier_id | bigint | NOT NULL | 0 | 供应商 ID |
| supplier_name | varchar(100) | NOT NULL | '' | 供应商名称（冗余字段） |
| deadline | datetime | NOT NULL | '1970-01-01 00:00:00' | 报价截止时间（继承采购单的 inquiry_deadline） |
| status | int | NOT NULL | 0 | 询价状态（见状态枚举） |
| item_count | int | NOT NULL | 0 | 询价商品数量（该供应商能供应的商品数） |
| is_deleted | tinyint | NOT NULL | 0 | 是否删除（0-未删除，1-已删除） |
| ctime | datetime | NOT NULL | CURRENT_TIMESTAMP | 创建时间（询价单发送时间） |
| mtime | datetime | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 2.4 索引设计

| 索引名称             | 索引类型 | 字段       | 说明         |
| -------------------- | -------- | ---------- | ------------ |
| PRIMARY              | 主键     | id         | 主键索引     |
| uk_inquiry_no        | 唯一索引 | inquiry_no | 询价单号唯一 |
| idx_inquiry_order_no | 普通索引 | order_no   | 采购单号查询 |

### 2.5 状态枚举

| 状态码 | 状态名称 | 说明                         |
| ------ | -------- | ---------------------------- |
| 0      | 待报价   | 询价单已发送，等待供应商报价 |
| 1      | 已报价   | 供应商已完成报价             |
| 2      | 未报价   | 超过截止时间未报价（超时）   |
| 3      | 已选中   | 该供应商的报价被采购员选中   |

### 2.6 建表 SQL

```sql
CREATE TABLE `tb_inquiry` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `inquiry_no` bigint NOT NULL DEFAULT '0' COMMENT '询价单号',
  `order_id` bigint NOT NULL DEFAULT '0' COMMENT '采购单主表ID',
  `order_no` bigint NOT NULL DEFAULT '0' COMMENT '采购单号',
  `supplier_id` bigint NOT NULL DEFAULT '0' COMMENT '供应商ID',
  `supplier_name` varchar(100) NOT NULL DEFAULT '' COMMENT '供应商名称',
  `deadline` datetime NOT NULL DEFAULT '1970-01-01 00:00:00' COMMENT '报价截止时间',
  `status` int NOT NULL DEFAULT '0' COMMENT '询价状态',
  `item_count` int NOT NULL DEFAULT '0' COMMENT '询价商品数量',
  `is_deleted` tinyint NOT NULL DEFAULT '0' COMMENT '是否删除',
  `ctime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_inquiry_no` (`inquiry_no`),
  KEY `idx_inquiry_order_no` (`order_no`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='询价单主表';
```

### 2.7 字段说明补充

**询价单号生成规则：**

- 使用 `NewIdGenerator` 生成唯一 ID
- BizName: `inquiry`
- BizPrefix: 11
- 时间模式：`TimeModeDatePlusSeconds`（DateFormat=`"060102"`，SeqWidth=`4`）
- 示例：`11251121495060001`

**询价单生成规则：**

- 系统根据采购单中的商品，查找能提供这些商品的供应商
- 为每个供应商生成一个询价单
- 每个询价单只包含该供应商能供应的商品（通过商品-供应商绑定表查询）
- 询价截止时间继承采购单的 `inquiry_deadline`

**状态流转：**

- 创建时：status = 0（待报价）
- 供应商提交报价后：status = 1（已报价）
- 超过截止时间未报价：status = 2（未报价）
- 采购员选择该供应商后：status = 3（已选中）

---

## 3. 询价单明细表

### 3.1 表名

`tb_inquiry_item`

### 3.2 表说明

存储询价单中包含的商品明细。每个询价单对应多个明细，每个明细对应采购单中的一个商品（该供应商能供应的商品）。

### 3.3 表结构

| 字段名 | 数据类型 | 是否为空 | 默认值 | 说明 |
| --- | --- | --- | --- | --- |
| id | bigint | NOT NULL | 自增 | 主键 ID |
| inquiry_id | bigint | NOT NULL | 0 | 询价单主表 ID |
| inquiry_no | bigint | NOT NULL | 0 | 询价单号（冗余字段，便于查询） |
| order_item_id | bigint | NOT NULL | 0 | 采购单明细 ID（关联 tb_purchase_order_item） |
| order_no | bigint | NOT NULL | 0 | 采购单号（冗余字段） |
| sku_id | bigint | NOT NULL | 0 | 商品 SKU ID（冗余字段） |
| product_name | varchar(200) | NOT NULL | '' | 商品名称（冗余字段） |
| brand | varchar(50) | NOT NULL | '' | 品牌名称（冗余字段） |
| quantity | int | NOT NULL | 0 | 采购数量（从采购单明细继承） |
| avg_price | decimal(10,2) | NULL | NULL | 采购均价（从采购单明细继承，用于价格对比） |
| is_deleted | tinyint | NOT NULL | 0 | 是否删除（0-未删除，1-已删除） |
| ctime | datetime | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| mtime | datetime | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 3.4 索引设计

| 索引名称          | 索引类型 | 字段       | 说明         |
| ----------------- | -------- | ---------- | ------------ |
| PRIMARY           | 主键     | id         | 主键索引     |
| idx_ii_inquiry_no | 普通索引 | inquiry_no | 询价单号查询 |

### 3.5 建表 SQL

```sql
CREATE TABLE `tb_inquiry_item` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `inquiry_id` bigint NOT NULL DEFAULT '0' COMMENT '询价单主表ID',
  `inquiry_no` bigint NOT NULL DEFAULT '0' COMMENT '询价单号',
  `order_item_id` bigint NOT NULL DEFAULT '0' COMMENT '采购单明细ID',
  `order_no` bigint NOT NULL DEFAULT '0' COMMENT '采购单号',
  `sku_id` bigint NOT NULL DEFAULT '0' COMMENT '商品SKU ID',
  `product_name` varchar(200) NOT NULL COMMENT '商品名称',
  `brand` varchar(50) NOT NULL COMMENT '品牌名称',
  `quantity` int NOT NULL DEFAULT '0' COMMENT '采购数量',
  `avg_price` decimal(10,2) DEFAULT NULL COMMENT '采购均价',
  `is_deleted` tinyint NOT NULL DEFAULT '0' COMMENT '是否删除',
  `ctime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_ii_inquiry_no` (`inquiry_no`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='询价单明细表';
```

### 3.6 字段说明补充

**明细生成规则：**

- 系统根据商品-供应商绑定表，查询该供应商能供应的商品
- 只将采购单中该供应商能供应的商品添加到询价单明细中
- 不同供应商的询价单，明细可能不同

**冗余字段说明：**

- `order_item_id`：关联采购单明细，用于追溯原始采购需求
- `order_no`、`sku_id`、`product_name`、`brand`：冗余存储，减少关联查询
- `quantity`、`avg_price`：从采购单明细继承，用于报价对比

---

## 4. 供应商报价表

### 4.1 表名

`tb_supplier_quote`

### 4.2 表说明

存储供应商对询价单的报价主信息。一个询价单对应一个报价（供应商只能提交一次报价）。

### 4.3 表结构

| 字段名 | 数据类型 | 是否为空 | 默认值 | 说明 |
| --- | --- | --- | --- | --- |
| id | bigint | NOT NULL | 自增 | 主键 ID |
| quote_no | bigint | NOT NULL | 0 | 报价单号（业务主键，使用 ID 生成算法生成） |
| inquiry_id | bigint | NOT NULL | 0 | 询价单 ID |
| inquiry_no | bigint | NOT NULL | 0 | 询价单号（冗余字段，便于查询） |
| order_id | bigint | NOT NULL | 0 | 采购单主表 ID |
| order_no | bigint | NOT NULL | 0 | 采购单号（冗余字段，便于查询） |
| supplier_id | bigint | NOT NULL | 0 | 供应商 ID |
| supplier_name | varchar(100) | NOT NULL | '' | 供应商名称（冗余字段） |
| total_amount | decimal(10,2) | NOT NULL | 0.00 | 报价总金额（所有明细的总价之和） |
| expected_delivery_days | int | NOT NULL | 0 | 预计交货天数（从下单到交货的天数） |
| remark | varchar(500) | NOT NULL | '' | 报价备注说明（供应商的补充说明） |
| status | int | NOT NULL | 0 | 报价状态（见状态枚举） |
| submit_user_id | bigint | NOT NULL | 0 | 提交人 ID（供应商端用户 ID） |
| submit_user_name | varchar(50) | NOT NULL | '' | 提交人姓名（冗余字段） |
| submit_time | datetime | NOT NULL | '1970-01-01 00:00:00' | 提交报价时间 |
| is_deleted | tinyint | NOT NULL | 0 | 是否删除（0-未删除，1-已删除） |
| ctime | datetime | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| mtime | datetime | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 4.4 索引设计

| 索引名称          | 索引类型 | 字段       | 说明         |
| ----------------- | -------- | ---------- | ------------ |
| PRIMARY           | 主键     | id         | 主键索引     |
| uk_quote_no       | 唯一索引 | quote_no   | 报价单号唯一 |
| idx_sq_inquiry_no | 普通索引 | inquiry_no | 询价单号查询 |
| idx_sq_order_no   | 普通索引 | order_no   | 采购单号查询 |

### 4.5 状态枚举

| 状态码 | 状态名称 | 说明               |
| ------ | -------- | ------------------ |
| 0      | 草稿     | 供应商保存但未提交 |
| 1      | 已提交   | 供应商已提交报价   |
| 2      | 已选中   | 该报价被采购员选中 |
| 3      | 未选中   | 该报价未被选中     |

### 4.6 建表 SQL

```sql
CREATE TABLE `tb_supplier_quote` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `quote_no` bigint NOT NULL DEFAULT '0' COMMENT '报价单号',
  `inquiry_id` bigint NOT NULL DEFAULT '0' COMMENT '询价单ID',
  `inquiry_no` bigint NOT NULL DEFAULT '0' COMMENT '询价单号',
  `order_id` bigint NOT NULL DEFAULT '0' COMMENT '采购单主表ID',
  `order_no` bigint NOT NULL DEFAULT '0' COMMENT '采购单号',
  `supplier_id` bigint NOT NULL DEFAULT '0' COMMENT '供应商ID',
  `supplier_name` varchar(100) NOT NULL DEFAULT '' COMMENT '供应商名称',
  `total_amount` decimal(10,2) NOT NULL DEFAULT '0.00' COMMENT '报价总金额',
  `expected_delivery_days` int NOT NULL DEFAULT '0' COMMENT '预计交货天数',
  `remark` varchar(500) NOT NULL DEFAULT '' COMMENT '报价备注说明',
  `status` int NOT NULL DEFAULT '0' COMMENT '报价状态',
  `submit_user_id` bigint NOT NULL DEFAULT '0' COMMENT '提交人ID',
  `submit_user_name` varchar(50) NOT NULL DEFAULT '' COMMENT '提交人姓名',
  `submit_time` datetime NOT NULL DEFAULT '1970-01-01 00:00:00' COMMENT '提交报价时间',
  `is_deleted` tinyint NOT NULL DEFAULT '0' COMMENT '是否删除',
  `ctime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_quote_no` (`quote_no`),
  KEY `idx_sq_inquiry_no` (`inquiry_no`),
  KEY `idx_sq_order_no` (`order_no`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='供应商报价表';
```

### 4.7 字段说明补充

**报价单号生成规则：**

- 使用 `NewIdGenerator` 生成唯一 ID
- BizName: `supplier_quote`
- BizPrefix: `30`（示例，根据实际业务需求调整）
- 示例：`302024112015000100001`

**报价流程：**

1. 供应商查看询价单，填写报价明细（单价、预计交货期、备注）
2. 系统自动计算总金额 = Σ(单价 × 数量)
3. 供应商保存草稿：status = 0（草稿）
4. 供应商提交报价：status = 1（已提交），记录 `submit_time`、`submit_user_id`、`submit_user_name`
5. 采购员选择供应商后：status = 2（已选中）或 3（未选中）

**预计交货期：**

- `expected_delivery_days`：从下单到交货的预计天数
- 供应商填写，用于采购员比价时考虑交货期因素

---

## 5. 供应商报价明细表

### 5.1 表名

`tb_supplier_quote_item`

### 5.2 表说明

存储供应商对询价单中每个商品的报价明细。一个报价对应多个报价明细。

### 5.3 表结构

| 字段名 | 数据类型 | 是否为空 | 默认值 | 说明 |
| --- | --- | --- | --- | --- |
| id | bigint | NOT NULL | 自增 | 主键 ID |
| quote_id | bigint | NOT NULL | 0 | 报价单主表 ID |
| quote_no | bigint | NOT NULL | 0 | 报价单号（冗余字段，便于查询） |
| inquiry_item_id | bigint | NOT NULL | 0 | 询价单明细 ID（关联 tb_inquiry_item） |
| order_item_id | bigint | NOT NULL | 0 | 采购单明细 ID（冗余字段） |
| sku_id | bigint | NOT NULL | 0 | 商品 SKU ID（冗余字段） |
| product_name | varchar(200) | NOT NULL | '' | 商品名称（冗余字段） |
| brand | varchar(50) | NOT NULL | '' | 品牌名称（冗余字段） |
| quantity | int | NOT NULL | 0 | 采购数量（从询价单明细继承） |
| quote_price | decimal(10,2) | NOT NULL | 0.00 | 报价单价（供应商对该商品的报价） |
| total_price | decimal(10,2) | NOT NULL | 0.00 | 报价总价（quote_price × quantity） |
| avg_price | decimal(10,2) | NULL | NULL | 采购均价（从询价单明细继承，用于价格对比） |
| price_diff_percent | decimal(5,2) | NULL | NULL | 与采购均价的差异百分比（用于价格审批判断） |
| expected_delivery_days | int | NOT NULL | 0 | 预计交货天数（该商品的预计交货期） |
| remark | varchar(500) | NOT NULL | '' | 报价备注（供应商的补充说明，如品牌、产地等） |
| is_deleted | tinyint | NOT NULL | 0 | 是否删除（0-未删除，1-已删除） |
| ctime | datetime | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| mtime | datetime | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 5.4 索引设计

| 索引名称              | 索引类型 | 字段          | 说明           |
| --------------------- | -------- | ------------- | -------------- |
| PRIMARY               | 主键     | id            | 主键索引       |
| idx_sqi_quote_no      | 普通索引 | quote_no      | 报价单号查询   |
| idx_sqi_order_item_id | 普通索引 | order_item_id | 采购单明细查询 |

### 5.5 建表 SQL

```sql
CREATE TABLE `tb_supplier_quote_item` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `quote_id` bigint NOT NULL DEFAULT '0' COMMENT '报价单主表ID',
  `quote_no` bigint NOT NULL DEFAULT '0' COMMENT '报价单号',
  `inquiry_item_id` bigint NOT NULL DEFAULT '0' COMMENT '询价单明细ID',
  `order_item_id` bigint NOT NULL DEFAULT '0' COMMENT '采购单明细ID',
  `sku_id` bigint NOT NULL DEFAULT '0' COMMENT '商品SKU ID',
  `product_name` varchar(200) NOT NULL COMMENT '商品名称',
  `brand` varchar(50) NOT NULL COMMENT '品牌名称',
  `quantity` int NOT NULL DEFAULT '0' COMMENT '采购数量',
  `quote_price` decimal(10,2) NOT NULL DEFAULT '0.00' COMMENT '报价单价',
  `total_price` decimal(10,2) NOT NULL DEFAULT '0.00' COMMENT '报价总价',
  `avg_price` decimal(10,2) DEFAULT NULL COMMENT '采购均价',
  `price_diff_percent` decimal(5,2) DEFAULT NULL COMMENT '与采购均价的差异百分比',
  `expected_delivery_days` int NOT NULL DEFAULT '0' COMMENT '预计交货天数',
  `remark` varchar(500) NOT NULL DEFAULT '' COMMENT '报价备注',
  `is_deleted` tinyint NOT NULL DEFAULT '0' COMMENT '是否删除',
  `ctime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_sqi_quote_no` (`quote_no`),
  KEY `idx_sqi_order_item_id` (`order_item_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='供应商报价明细表';
```

### 5.6 字段说明补充

**报价明细生成规则：**

- 供应商对询价单中的每个商品进行报价
- 每个询价单明细对应一个报价明细
- 报价明细必须填写：单价、预计交货期
- 报价备注可选（如品牌、产地、规格等补充说明）

**价格计算：**

- `total_price` = `quote_price` × `quantity`（系统自动计算）
- `price_diff_percent` = `(quote_price - avg_price) / avg_price × 100`（系统自动计算）
- 用于价格审批判断：如果 `price_diff_percent` ≥ 15%（阈值可配置），触发价格审批

**预计交货期：**

- `expected_delivery_days`：该商品从下单到交货的预计天数
- 供应商填写，用于采购员比价时考虑交货期因素
- 报价主表中的 `expected_delivery_days` 可以是所有明细中最长的交货期，或供应商填写的整体交货期

---

## 6. 表关系说明

### 6.1 主从关系

```
tb_purchase_order (1) ----< (N) tb_inquiry
tb_inquiry (1) ----< (N) tb_inquiry_item
tb_inquiry (1) ----< (1) tb_supplier_quote
tb_supplier_quote (1) ----< (N) tb_supplier_quote_item
tb_purchase_order_item (1) ----< (N) tb_inquiry_item
tb_inquiry_item (1) ----< (1) tb_supplier_quote_item
```

**关系说明：**

- 一个采购单可以对应多个询价单（每个供应商一个）
- 一个询价单包含多个询价明细（该供应商能供应的商品）
- 一个询价单对应一个报价（供应商只能提交一次报价）
- 一个报价包含多个报价明细（对每个询价明细的报价）
- 询价明细关联采购单明细（追溯原始采购需求）
- 报价明细关联询价明细（追溯询价信息）

### 6.2 关联关系图

```
                    ┌─────────────────────────┐
                    │  tb_purchase_order      │
                    │  (采购单主表)           │
                    └─────────────────────────┘
                            │
                            │ 1:N
                            │
                            ▼
                    ┌─────────────────────────┐
                    │  tb_inquiry              │
                    │  (询价单主表)           │
                    ├─────────────────────────┤
                    │ id (PK)                 │
                    │ inquiry_no (UK)          │
                    │ order_id (FK)           │
                    │ supplier_id             │
                    │ status                  │
                    │ ...                     │
                    └─────────────────────────┘
                            │
                            │ 1:N                   1:1
                            │                        │
                            ▼                        ▼
                    ┌──────────────────┐  ┌──────────────────────┐
                    │ tb_inquiry_item  │  │ tb_supplier_quote    │
                    │ (询价单明细表)   │  │ (供应商报价表)       │
                    ├──────────────────┤  ├──────────────────────┤
                    │ id (PK)          │  │ id (PK)               │
                    │ inquiry_id (FK)  │  │ quote_no (UK)         │
                    │ order_item_id    │  │ inquiry_id (FK)       │
                    │ sku_id           │  │ supplier_id           │
                    │ quantity         │  │ total_amount          │
                    │ ...              │  │ status               │
                    └──────────────────┘  │ ...                  │
                            │              └──────────────────────┘
                            │ 1:1                  │
                            │                      │ 1:N
                            │                      │
                            ▼                      ▼
                    ┌──────────────────────────────┐
                    │ tb_supplier_quote_item       │
                    │ (供应商报价明细表)            │
                    ├──────────────────────────────┤
                    │ id (PK)                      │
                    │ quote_id (FK)                │
                    │ inquiry_item_id (FK)         │
                    │ quote_price                  │
                    │ expected_delivery_days       │
                    │ remark                       │
                    │ ...                          │
                    └──────────────────────────────┘
```

---

## 7. 数据流转说明

### 7.1 询价单生成流程

**触发条件：**

- 采购单审核通过（第一版：提交后自动审核通过，状态变为 3-询价中）

**生成步骤：**

1. 系统查询采购单明细，获取所有商品（sku_id）
2. 根据商品-供应商绑定表，查询能提供这些商品的供应商
3. 为每个供应商生成一个询价单：
   - 生成询价单号（使用 ID 生成算法）
   - 设置供应商信息
   - 设置询价截止时间（继承采购单的 inquiry_deadline）
   - 状态设为 1（待报价）
4. 为每个询价单生成明细：
   - 只包含该供应商能供应的商品
   - 从采购单明细继承商品信息、数量、采购均价
5. 发送询价通知给供应商

### 7.2 供应商报价流程

**报价步骤：**

1. 供应商登录外部门户，查看询价单列表
2. 点击询价单，查看询价明细（只显示该供应商能供应的商品）
3. 填写报价信息：
   - 对每个商品填写：单价、预计交货期、备注
   - 系统自动计算总价 = Σ(单价 × 数量)
4. 保存草稿：status = 0（草稿），可随时修改
5. 提交报价：status = 1（已提交），记录提交时间和提交人
6. 提交后不可再修改（截止时间前可修改草稿）

### 7.3 报价状态流转

**状态变更：**

- 创建报价：status = 0（草稿）
- 提交报价：status = 1（已提交）
- 超过截止时间未报价：询价单 status = 2（未报价），不生成报价记录
- 采购员选择供应商：报价 status = 2（已选中），询价单 status = 3（已选中）
- 采购员未选择：报价 status = 3（未选中）

### 7.4 比价与选择流程

**重要说明：**

- 采购单状态 3（询价中）包含以下阶段：
  - 系统发送询价给供应商
  - 供应商提交报价
  - 采购员查看报价信息和对比价格
- 采购单状态 4（已选择报价）表示：采购员已确认选择某个供应商的报价

**比价步骤：**

1. 采购单状态为 3（询价中）时，采购员可查看所有供应商的报价
2. 系统按商品维度展示报价对比：
   - 每个商品显示所有供应商的报价
   - 显示采购均价作为基准
   - 计算与均价的差异百分比
   - 标识最低价供应商
3. 采购员对比价格后，选择供应商（可选择一个或多个）
4. 采购员确认选择后：
   - 报价 status = 2（已选中），询价单 status = 3（已选中）
   - 采购单状态变为 4（已选择报价）
5. 系统检查价格：
   - 如果报价超过采购均价 15%（阈值可配置），触发价格审批
   - 采购单状态变为 5（价格待审批）
   - 采购员填写超价原因
   - 系统管理员审批
6. 价格审批通过后，采购单状态变为 7（已下单）

---

## 8. 查询示例

### 8.1 查询采购单的所有询价单

```sql
-- 查询采购单的所有询价单及其状态
SELECT
  i.id,
  i.inquiry_no,
  i.supplier_id,
  i.supplier_name,
  i.deadline,
  i.status,
  i.item_count,
  i.ctime
FROM tb_inquiry i
WHERE i.order_no = '102024112015000100001'
  AND i.is_deleted = 0
ORDER BY i.ctime ASC;
```

### 8.2 查询询价单的明细

```sql
-- 查询询价单的商品明细
SELECT
  ii.id,
  ii.sku_id,
  ii.product_name,
  ii.brand,
  ii.quantity,
  ii.avg_price
FROM tb_inquiry_item ii
WHERE ii.inquiry_no = '202024112015000100001'
  AND ii.is_deleted = 0
ORDER BY ii.id ASC;
```

### 8.3 查询供应商的报价

```sql
-- 查询询价单对应的报价
SELECT
  sq.id,
  sq.quote_no,
  sq.total_amount,
  sq.expected_delivery_days,
  sq.status,
  sq.submit_time,
  sq.submit_user_name
FROM tb_supplier_quote sq
WHERE sq.inquiry_no = '202024112015000100001'
  AND sq.is_deleted = 0;
```

### 8.4 查询报价明细

```sql
-- 查询报价的商品明细
SELECT
  sqi.id,
  sqi.sku_id,
  sqi.product_name,
  sqi.brand,
  sqi.quantity,
  sqi.quote_price,
  sqi.total_price,
  sqi.avg_price,
  sqi.price_diff_percent,
  sqi.expected_delivery_days,
  sqi.remark
FROM tb_supplier_quote_item sqi
WHERE sqi.quote_no = '302024112015000100001'
  AND sqi.is_deleted = 0
ORDER BY sqi.id ASC;
```

### 8.5 查询采购单的所有报价（比价视图）

```sql
-- 查询采购单的所有报价，用于比价
SELECT
  sq.id AS quote_id,
  sq.quote_no,
  sq.supplier_id,
  sq.supplier_name,
  sq.total_amount,
  sq.expected_delivery_days AS overall_delivery_days,
  sq.status AS quote_status,
  sqi.sku_id,
  sqi.product_name,
  sqi.brand,
  sqi.quantity,
  sqi.quote_price,
  sqi.total_price,
  sqi.avg_price,
  sqi.price_diff_percent,
  sqi.expected_delivery_days AS item_delivery_days
FROM tb_supplier_quote sq
JOIN tb_supplier_quote_item sqi ON sq.id = sqi.quote_id AND sqi.is_deleted = 0
WHERE sq.order_no = '102024112015000100001'
  AND sq.is_deleted = 0
  AND sq.status = 1  -- 已提交的报价
ORDER BY sq.supplier_id, sqi.id;
```

### 8.6 查询未报价的供应商

```sql
-- 查询超过截止时间未报价的供应商
SELECT
  i.id,
  i.inquiry_no,
  i.supplier_id,
  i.supplier_name,
  i.deadline,
  i.ctime
FROM tb_inquiry i
WHERE i.order_no = '102024112015000100001'
  AND i.status = 0  -- 待报价
  AND i.deadline < NOW()  -- 已超过截止时间
  AND i.is_deleted = 0;
```

### 8.7 统计报价情况

```sql
-- 统计采购单的报价情况
SELECT
  COUNT(DISTINCT i.id) AS total_inquiries,
  COUNT(DISTINCT CASE WHEN i.status = 1 THEN i.id END) AS quoted_count,
  COUNT(DISTINCT CASE WHEN i.status = 2 THEN i.id END) AS timeout_count,
  COUNT(DISTINCT CASE WHEN i.status = 3 THEN i.id END) AS selected_count
FROM tb_inquiry i
WHERE i.order_no = '102024112015000100001'
  AND i.is_deleted = 0;
```

---

## 9. 性能优化建议

### 9.1 索引优化

- 主表仅保留主键和业务主键唯一索引，简化索引结构
- 根据实际查询场景，如发现性能瓶颈，可考虑添加：
  - `idx_inquiry_supplier_id`：供应商维度查询
  - `idx_inquiry_status`：状态维度查询
  - `idx_inquiry_deadline`：截止时间查询
  - `idx_quote_supplier_id`：供应商报价查询
  - `idx_quote_status`：报价状态查询
- 定期分析慢查询日志，按需添加索引

### 9.2 数据归档

- 状态为"已选中"或"未选中"且超过 1 年的报价记录，可归档到历史表
- 保留最近 2 年的热数据在主表中

### 9.3 查询优化

- 比价查询时，考虑使用缓存存储报价对比结果
- 对于高频查询（如供应商查看自己的询价单），考虑建立视图

---

## 10. 数据完整性约束

### 10.1 应用层约束

- 询价单号必须全局唯一
- 报价单号必须全局唯一
- 一个询价单只能对应一个报价（供应商只能提交一次）
- 报价明细的 `quote_id` 必须在报价主表中存在
- 询价明细的 `inquiry_id` 必须在询价主表中存在
- 删除询价单时，必须同时软删除所有明细和报价
- `total_price` = `quote_price` × `quantity`
- `price_diff_percent` = `(quote_price - avg_price) / avg_price × 100`

### 10.2 业务规则

- 询价单必须在采购单审核通过后自动生成
- 报价必须在询价截止时间前提交
- 超过截止时间后，询价单状态自动变为"未报价"
- 报价提交后不可再修改
- 采购员选择供应商后，报价状态变为"已选中"
- 价格审批通过后，才能将报价状态设为"已选中"

---

## 11. 变更记录

| 版本 | 日期       | 变更内容 | 变更人       |
| ---- | ---------- | -------- | ------------ |
| 1.0  | 2025-11-21 | 初始版本 | 系统架构团队 |

---

## 附录 A. 采购单相关基础表

### A.1 `tb_purchase_order`

| 字段名 | 数据类型 | 是否为空 | 默认值 | 说明 |
| --- | --- | --- | --- | --- |
| id | bigint | NOT NULL | 自增 | 主键 ID |
| order_no | bigint | NOT NULL | 0 | 采购单号 |
| store_id | bigint | NOT NULL | 0 | 采购门店 ID |
| creator_id | bigint | NOT NULL | 0 | 创建人 ID |
| expected_delivery_date | datetime | NOT NULL | '1970-01-01 00:00:00' | 期望到货日期 |
| inquiry_deadline | datetime | NOT NULL | '1970-01-01 00:00:00' | 询价截止时间 |
| remark | varchar(500) | NOT NULL | '' | 备注说明 |
| status | int | NOT NULL | 0 | 采购单状态 |
| order_type | tinyint | NOT NULL | 0 | 订单类型 |
| is_deleted | tinyint | NOT NULL | 0 | 是否删除 |
| ctime | datetime | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| mtime | datetime | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

> 业务规则补充：`order_no` 使用 Redis 分布式 ID 生成器，格式为 `10 + YYMMDD + 秒 + 序列`。

### A.2 `tb_purchase_order_item`

| 字段名 | 数据类型 | 是否为空 | 默认值 | 说明 |
| --- | --- | --- | --- | --- |
| id | bigint | NOT NULL | 自增 | 主键 ID |
| order_id | bigint | NOT NULL | 0 | 采购单主表 ID |
| order_no | bigint | NOT NULL | 0 | 采购单号 |
| sku_id | bigint | NOT NULL | 0 | 商品 SKU ID |
| product_name | varchar(200) | NOT NULL | '' | 商品名称 |
| brand | varchar(50) | NOT NULL | '' | 品牌名称 |
| category_id | bigint | NOT NULL | 0 | 商品分类 ID |
| category_name | varchar(100) | NULL | NULL | 商品分类名称 |
| quantity | int | NOT NULL | 0 | 采购数量 |
| avg_price | decimal(10,2) | NULL | NULL | 采购均价 |
| selected_supplier_id | bigint | NULL | NULL | 选中的供应商 ID |
| selected_supplier_name | varchar(100) | NULL | NULL | 选中的供应商名称 |
| actual_price | decimal(10,2) | NULL | NULL | 实际成交单价 |
| actual_total_price | decimal(10,2) | NULL | NULL | 实际成交总价 |
| remark | varchar(128) | NOT NULL | '' | 明细备注 |
| is_deleted | tinyint | NOT NULL | 0 | 是否删除 |
| ctime | datetime | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| mtime | datetime | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### A.3 `tb_purchase_order_status_log`

| 字段名        | 数据类型     | 是否为空 | 默认值            | 说明          |
| ------------- | ------------ | -------- | ----------------- | ------------- |
| id            | bigint       | NOT NULL | 自增              | 主键 ID       |
| order_id      | bigint       | NOT NULL | 0                 | 采购单主表 ID |
| order_no      | bigint       | NOT NULL | 0                 | 采购单号      |
| from_status   | int          | NOT NULL | 0                 | 变更前状态    |
| to_status     | int          | NOT NULL | 0                 | 变更后状态    |
| operator_id   | bigint       | NOT NULL | 0                 | 操作人 ID     |
| operator_name | varchar(30)  | NOT NULL | ''                | 操作人姓名    |
| remark        | varchar(128) | NOT NULL | ''                | 操作说明/备注 |
| ctime         | datetime     | NOT NULL | CURRENT_TIMESTAMP | 状态变更时间  |

> 说明：状态流转记录与采购单状态枚举保持一致（参考 `PurchaseOrderStatusEnum`），用于追溯自动审批、自动发起询价等动作。

---

**文档结束**

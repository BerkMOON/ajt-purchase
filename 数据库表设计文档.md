# 奥吉通集团配件集采系统 - 数据库表设计文档

**版本：** 1.0 **日期：** 2024-10-15 **文档状态：** 草案

---

## 目录

1. [概述](#概述)
2. [表结构设计](#表结构设计)
3. [索引设计](#索引设计)
4. [状态流转规则](#状态流转规则)
5. [数据字典](#数据字典)

---

## 概述

本文档定义了奥吉通集团配件集采系统中采购单及其状态流转相关的核心数据库表结构。设计遵循以下原则：

- **规范化设计**：避免数据冗余，保持数据一致性
- **可追溯性**：完整记录状态变更和操作日志
- **可扩展性**：预留字段空间，支持未来业务扩展
- **性能优化**：合理设置索引，支持高效查询

---

## 表结构设计

### 1. 采购单主表 (purchase_order)

采购单的核心信息表，记录采购单的基本信息和当前状态。

| 字段名 | 数据类型 | 长度 | 允许空 | 默认值 | 说明 |
| --- | --- | --- | --- | --- | --- |
| id | BIGINT | - | 否 | 自增 | 主键 ID |
| order_no | VARCHAR | 32 | 否 | - | 采购单号（唯一，格式：PO+年月日+6 位序号，如 PO2024101500001） |
| order_type | VARCHAR | 20 | 否 | PARTS | 采购类型：PARTS(备件)/ACCESSORIES(精品)/MIXED(混合) |
| store_id | BIGINT | - | 否 | - | 采购门店 ID |
| store_name | VARCHAR | 100 | 否 | - | 采购门店名称（冗余字段，便于查询） |
| creator_id | BIGINT | - | 否 | - | 创建人 ID（采购员） |
| creator_name | VARCHAR | 50 | 否 | - | 创建人姓名（冗余字段） |
| expected_delivery_date | DATE | - | 否 | - | 期望到货日期 |
| status | TINYINT | - | 否 | 1 | 当前状态：1-草稿 2-待审核 3-审核通过 4-已驳回 5-待询价 6-已报价 7-订单待审核 8-已下单 9-已完成 |
| estimated_amount | DECIMAL | 12,2 | 是 | NULL | 参考预估金额（基于历史均价计算，仅供参考） |
| lowest_quote_amount | DECIMAL | 12,2 | 是 | NULL | 最低报价金额（报价完成后，系统自动计算所有报价中的最低价） |
| final_amount | DECIMAL | 12,2 | 是 | NULL | 最终成交金额（选择供应商后填充） |
| remark | TEXT | - | 是 | NULL | 备注说明 |
| submit_time | DATETIME | - | 是 | NULL | 提交审核时间 |
| first_audit_id | BIGINT | - | 是 | NULL | 采购单审核员 ID |
| first_audit_name | VARCHAR | 50 | 是 | NULL | 采购单审核员姓名 |
| first_audit_time | DATETIME | - | 是 | NULL | 采购单审核时间 |
| first_audit_result | TINYINT | - | 是 | NULL | 采购单审核结果：1-通过 2-驳回 |
| first_audit_remark | TEXT | - | 是 | NULL | 采购单审核备注/驳回理由 |
| second_audit_id | BIGINT | - | 是 | NULL | 订单审核员 ID（如果拆单，以最后一个订单审核为准） |
| second_audit_name | VARCHAR | 50 | 是 | NULL | 订单审核员姓名 |
| second_audit_time | DATETIME | - | 是 | NULL | 订单审核时间 |
| second_audit_result | TINYINT | - | 是 | NULL | 订单审核结果：1-通过 2-驳回 |
| second_audit_remark | TEXT | - | 是 | NULL | 订单审核备注/驳回理由 |
| supplier_count | TINYINT | - | 是 | 0 | 选中的供应商数量（统一供应商为 1，拆单时>1） |
| contract_count | TINYINT | - | 是 | 0 | 生成的订单数量（与 supplier_count 一致） |
| inquiry_deadline | DATETIME | - | 是 | NULL | 询价截止时间 |
| completed_time | DATETIME | - | 是 | NULL | 完成时间 |
| is_deleted | TINYINT | - | 否 | 0 | 逻辑删除标识：0-正常 1-已删除 |
| create_time | DATETIME | - | 否 | CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | - | 否 | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**表注释**：采购单主表，存储采购单的核心信息和当前状态

---

### 2. 采购单明细表 (purchase_order_item)

记录采购单中的配件清单信息。

| 字段名 | 数据类型 | 长度 | 允许空 | 默认值 | 说明 |
| --- | --- | --- | --- | --- | --- |
| id | BIGINT | - | 否 | 自增 | 主键 ID |
| order_id | BIGINT | - | 否 | - | 采购单 ID（关联 purchase_order.id） |
| order_no | VARCHAR | 32 | 否 | - | 采购单号（冗余字段，便于查询） |
| part_id | BIGINT | - | 否 | - | 配件 ID |
| part_code | VARCHAR | 50 | 否 | - | 配件编码 |
| part_name | VARCHAR | 200 | 否 | - | 配件名称 |
| part_type | VARCHAR | 20 | 否 | - | 配件类型：PARTS(备件)/ACCESSORIES(精品) |
| specification | VARCHAR | 200 | 是 | NULL | 规格型号 |
| unit | VARCHAR | 20 | 否 | - | 计量单位 |
| quantity | DECIMAL | 10,2 | 否 | - | 采购数量 |
| historical_avg_price | DECIMAL | 10,2 | 是 | NULL | 历史平均价格（参考价，仅供参考） |
| selected_supplier_id | BIGINT | - | 是 | NULL | 该明细选中的供应商 ID（支持拆单场景） |
| selected_supplier_name | VARCHAR | 100 | 是 | NULL | 该明细选中的供应商名称 |
| selected_quote_item_id | BIGINT | - | 是 | NULL | 选中的报价明细 ID（关联 supplier_quote_item.id） |
| final_price | DECIMAL | 10,2 | 是 | NULL | 最终成交单价（选择供应商后从报价复制） |
| final_amount | DECIMAL | 12,2 | 是 | NULL | 最终成交总价（final_price \* quantity） |
| remark | VARCHAR | 500 | 是 | NULL | 明细备注 |
| sort_order | INT | - | 否 | 0 | 排序序号 |
| is_deleted | TINYINT | - | 否 | 0 | 逻辑删除标识：0-正常 1-已删除 |
| create_time | DATETIME | - | 否 | CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | - | 否 | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**表注释**：采购单明细表，记录采购单中的配件清单

---

### 3. 采购单状态流转记录表 (purchase_order_status_log)

完整记录采购单的状态变更历史，用于状态追溯和流程审计。

| 字段名 | 数据类型 | 长度 | 允许空 | 默认值 | 说明 |
| --- | --- | --- | --- | --- | --- |
| id | BIGINT | - | 否 | 自增 | 主键 ID |
| order_id | BIGINT | - | 否 | - | 采购单 ID（关联 purchase_order.id） |
| order_no | VARCHAR | 32 | 否 | - | 采购单号（冗余字段） |
| from_status | TINYINT | - | 是 | NULL | 原状态：1-9（NULL 表示初始创建） |
| to_status | TINYINT | - | 否 | - | 目标状态：1-9 |
| from_status_name | VARCHAR | 20 | 是 | NULL | 原状态名称（冗余字段，便于查询展示） |
| to_status_name | VARCHAR | 20 | 否 | - | 目标状态名称（冗余字段） |
| action_type | VARCHAR | 30 | 否 | - | 操作类型：CREATE(创建)/SUBMIT(提交)/APPROVE(审核通过)/REJECT(驳回)/INQUIRY(发送询价)/QUOTE(报价完成)/SELECT_SUPPLIER(选择供应商)/ORDER(下单)/COMPLETE(完成) |
| operator_id | BIGINT | - | 否 | - | 操作人 ID |
| operator_name | VARCHAR | 50 | 否 | - | 操作人姓名 |
| operator_role | VARCHAR | 30 | 否 | - | 操作人角色：PURCHASER(采购员)/AUDITOR(审核员)/SYSTEM(系统)/SUPPLIER(供应商) |
| remark | TEXT | - | 是 | NULL | 操作备注（如驳回理由等） |
| extra_data | JSON | - | 是 | NULL | 扩展数据（JSON 格式，存储额外信息） |
| ip_address | VARCHAR | 50 | 是 | NULL | 操作 IP 地址 |
| create_time | DATETIME | - | 否 | CURRENT_TIMESTAMP | 操作时间 |

**表注释**：采购单状态流转记录表，完整记录采购单的状态变更历史

---

### 4. 询价单表 (inquiry)

记录系统自动生成的询价单信息。

| 字段名 | 数据类型 | 长度 | 允许空 | 默认值 | 说明 |
| --- | --- | --- | --- | --- | --- |
| id | BIGINT | - | 否 | 自增 | 主键 ID |
| inquiry_no | VARCHAR | 32 | 否 | - | 询价单号（唯一，格式：INQ+年月日+6 位序号） |
| order_id | BIGINT | - | 否 | - | 关联的采购单 ID |
| order_no | VARCHAR | 32 | 否 | - | 采购单号（冗余字段） |
| supplier_id | BIGINT | - | 否 | - | 供应商 ID |
| supplier_name | VARCHAR | 100 | 否 | - | 供应商名称（冗余字段） |
| inquiry_type | VARCHAR | 20 | 否 | COMPETITIVE | 询价类型：COMPETITIVE(竞价询价-备件)/DIRECT(直接采购-精品) |
| status | TINYINT | - | 否 | 1 | 询价状态：1-待报价 2-已报价 3-已超时 4-已中标 5-未中标 |
| deadline | DATETIME | - | 否 | - | 报价截止时间 |
| send_time | DATETIME | - | 否 | CURRENT_TIMESTAMP | 发送时间 |
| notify_method | VARCHAR | 50 | 是 | NULL | 通知方式：SMS(短信)/EMAIL(邮件)/PORTAL(站内信)/ALL(全部) |
| is_quoted | TINYINT | - | 否 | 0 | 是否已报价：0-未报价 1-已报价 |
| quote_time | DATETIME | - | 是 | NULL | 报价时间 |
| is_selected | TINYINT | - | 否 | 0 | 是否被选中：0-未选中 1-已选中 |
| remark | TEXT | - | 是 | NULL | 备注 |
| is_deleted | TINYINT | - | 否 | 0 | 逻辑删除标识：0-正常 1-已删除 |
| create_time | DATETIME | - | 否 | CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | - | 否 | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**表注释**：询价单表，记录系统发送给供应商的询价信息

采购单创建 → 提交审核 → 审核通过 ↓ 【系统自动生成询价单】← 这里就是 inquiry 表的作用 ↓ 发送给多个供应商（每个供应商一条 inquiry 记录） ↓ 供应商收到询价 → 在线填写报价 → 提交报价（supplier_quote 表） ↓

---

### 5. 供应商报价表 (supplier_quote)

记录供应商针对询价单的报价明细。

| 字段名 | 数据类型 | 长度 | 允许空 | 默认值 | 说明 |
| --- | --- | --- | --- | --- | --- |
| id | BIGINT | - | 否 | 自增 | 主键 ID |
| quote_no | VARCHAR | 32 | 否 | - | 报价单号（唯一，格式：QT+年月日+6 位序号） |
| inquiry_id | BIGINT | - | 否 | - | 询价单 ID |
| inquiry_no | VARCHAR | 32 | 否 | - | 询价单号（冗余字段） |
| order_id | BIGINT | - | 否 | - | 采购单 ID |
| order_no | VARCHAR | 32 | 否 | - | 采购单号（冗余字段） |
| supplier_id | BIGINT | - | 否 | - | 供应商 ID |
| supplier_name | VARCHAR | 100 | 否 | - | 供应商名称（冗余字段） |
| total_amount | DECIMAL | 12,2 | 否 | - | 报价总金额 |
| expected_delivery_days | INT | - | 否 | - | 预计交货天数 |
| expected_delivery_date | DATE | - | 否 | - | 预计交货日期 |
| quote_remark | TEXT | - | 是 | NULL | 报价备注说明 |
| validity_days | INT | - | 否 | 30 | 报价有效期（天数） |
| quote_status | TINYINT | - | 否 | 1 | 报价状态：1-草稿 2-已提交 3-已中标 4-未中标 |
| is_selected | TINYINT | - | 否 | 0 | 是否被选中：0-未选中 1-已选中 |
| submit_time | DATETIME | - | 是 | NULL | 提交报价时间 |
| submit_user_id | BIGINT | - | 是 | NULL | 提交人 ID（供应商端用户） |
| submit_user_name | VARCHAR | 50 | 是 | NULL | 提交人姓名 |
| is_deleted | TINYINT | - | 否 | 0 | 逻辑删除标识：0-正常 1-已删除 |
| create_time | DATETIME | - | 否 | CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | - | 否 | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**表注释**：供应商报价表，记录供应商的报价信息

---

### 6. 供应商报价明细表 (supplier_quote_item)

记录供应商报价单中的配件明细报价。

| 字段名 | 数据类型 | 长度 | 允许空 | 默认值 | 说明 |
| --- | --- | --- | --- | --- | --- |
| id | BIGINT | - | 否 | 自增 | 主键 ID |
| quote_id | BIGINT | - | 否 | - | 报价单 ID（关联 supplier_quote.id） |
| quote_no | VARCHAR | 32 | 否 | - | 报价单号（冗余字段） |
| order_item_id | BIGINT | - | 否 | - | 采购单明细 ID（关联 purchase_order_item.id） |
| part_id | BIGINT | - | 否 | - | 配件 ID |
| part_code | VARCHAR | 50 | 否 | - | 配件编码 |
| part_name | VARCHAR | 200 | 否 | - | 配件名称 |
| specification | VARCHAR | 200 | 是 | NULL | 规格型号 |
| unit | VARCHAR | 20 | 否 | - | 计量单位 |
| quantity | DECIMAL | 10,2 | 否 | - | 采购数量 |
| quote_price | DECIMAL | 10,2 | 否 | - | 报价单价 |
| quote_amount | DECIMAL | 12,2 | 否 | - | 报价总价 |
| brand | VARCHAR | 50 | 是 | NULL | 品牌 |
| origin | VARCHAR | 50 | 是 | NULL | 产地 |
| delivery_days | INT | - | 是 | NULL | 该配件交货天数 |
| remark | VARCHAR | 500 | 是 | NULL | 明细备注 |
| is_deleted | TINYINT | - | 否 | 0 | 逻辑删除标识：0-正常 1-已删除 |
| create_time | DATETIME | - | 否 | CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | - | 否 | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**表注释**：供应商报价明细表，记录报价单中的配件明细

---

### 7. 采购订单表 (purchase_contract)

记录正式生成的采购订单（选定供应商后生成）。

| 字段名 | 数据类型 | 长度 | 允许空 | 默认值 | 说明 |
| --- | --- | --- | --- | --- | --- |
| id | BIGINT | - | 否 | 自增 | 主键 ID |
| contract_no | VARCHAR | 32 | 否 | - | 采购订单号（唯一，格式：PC+年月日+6 位序号） |
| order_id | BIGINT | - | 否 | - | 采购单 ID |
| order_no | VARCHAR | 32 | 否 | - | 采购单号（冗余字段） |
| quote_id | BIGINT | - | 否 | - | 报价单 ID（选中的报价） |
| quote_no | VARCHAR | 32 | 否 | - | 报价单号（冗余字段） |
| supplier_id | BIGINT | - | 否 | - | 供应商 ID |
| supplier_name | VARCHAR | 100 | 否 | - | 供应商名称（冗余字段） |
| store_id | BIGINT | - | 否 | - | 采购门店 ID |
| store_name | VARCHAR | 100 | 否 | - | 采购门店名称（冗余字段） |
| contract_amount | DECIMAL | 12,2 | 否 | - | 订单金额 |
| expected_delivery_date | DATE | - | 否 | - | 期望到货日期 |
| contract_status | TINYINT | - | 否 | 1 | 订单状态：1-待审核 2-审核通过 3-已驳回 4-已发货 5-已收货 6-已完成 7-已取消 |
| creator_id | BIGINT | - | 否 | - | 创建人 ID（采购员） |
| creator_name | VARCHAR | 50 | 否 | - | 创建人姓名 |
| create_order_time | DATETIME | - | 否 | CURRENT_TIMESTAMP | 订单创建时间 |
| audit_id | BIGINT | - | 是 | NULL | 审核人 ID |
| audit_name | VARCHAR | 50 | 是 | NULL | 审核人姓名 |
| audit_time | DATETIME | - | 是 | NULL | 审核时间 |
| audit_result | TINYINT | - | 是 | NULL | 审核结果：1-通过 2-驳回 |
| audit_remark | TEXT | - | 是 | NULL | 审核备注/驳回理由 |
| send_time | DATETIME | - | 是 | NULL | 发送给供应商时间 |
| delivery_time | DATETIME | - | 是 | NULL | 实际发货时间 |
| receive_time | DATETIME | - | 是 | NULL | 实际收货时间 |
| complete_time | DATETIME | - | 是 | NULL | 完成时间 |
| remark | TEXT | - | 是 | NULL | 订单备注 |
| is_deleted | TINYINT | - | 否 | 0 | 逻辑删除标识：0-正常 1-已删除 |
| create_time | DATETIME | - | 否 | CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | - | 否 | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**表注释**：采购订单表，记录正式生成的采购订单信息

---

### 8. 采购订单明细表 (purchase_contract_item)

记录采购订单的配件明细。

| 字段名 | 数据类型 | 长度 | 允许空 | 默认值 | 说明 |
| --- | --- | --- | --- | --- | --- |
| id | BIGINT | - | 否 | 自增 | 主键 ID |
| contract_id | BIGINT | - | 否 | - | 订单 ID（关联 purchase_contract.id） |
| contract_no | VARCHAR | 32 | 否 | - | 订单号（冗余字段） |
| quote_item_id | BIGINT | - | 否 | - | 报价明细 ID（关联 supplier_quote_item.id） |
| part_id | BIGINT | - | 否 | - | 配件 ID |
| part_code | VARCHAR | 50 | 否 | - | 配件编码 |
| part_name | VARCHAR | 200 | 否 | - | 配件名称 |
| specification | VARCHAR | 200 | 是 | NULL | 规格型号 |
| unit | VARCHAR | 20 | 否 | - | 计量单位 |
| quantity | DECIMAL | 10,2 | 否 | - | 采购数量 |
| contract_price | DECIMAL | 10,2 | 否 | - | 订单单价 |
| contract_amount | DECIMAL | 12,2 | 否 | - | 订单总价 |
| received_quantity | DECIMAL | 10,2 | 否 | 0.00 | 已收货数量 |
| brand | VARCHAR | 50 | 是 | NULL | 品牌 |
| origin | VARCHAR | 50 | 是 | NULL | 产地 |
| remark | VARCHAR | 500 | 是 | NULL | 明细备注 |
| is_deleted | TINYINT | - | 否 | 0 | 逻辑删除标识：0-正常 1-已删除 |
| create_time | DATETIME | - | 否 | CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | - | 否 | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**表注释**：采购订单明细表，记录订单中的配件明细

---

## 索引设计

### purchase_order 表索引

```sql
-- 主键索引
PRIMARY KEY (id)

-- 唯一索引
UNIQUE KEY uk_order_no (order_no)

-- 普通索引
KEY idx_store_id (store_id)
KEY idx_creator_id (creator_id)
KEY idx_status (status)
KEY idx_create_time (create_time)
KEY idx_submit_time (submit_time)
KEY idx_store_status (store_id, status)  -- 组合索引，用于门店查询自己的采购单

-- 删除标识索引
KEY idx_is_deleted (is_deleted)
```

### purchase_order_item 表索引

```sql
-- 主键索引
PRIMARY KEY (id)

-- 普通索引
KEY idx_order_id (order_id)
KEY idx_order_no (order_no)
KEY idx_part_id (part_id)
KEY idx_selected_supplier_id (selected_supplier_id)  -- 用于按供应商查询和分组
KEY idx_selected_quote_item_id (selected_quote_item_id)  -- 用于关联查询
```

### purchase_order_status_log 表索引

```sql
-- 主键索引
PRIMARY KEY (id)

-- 普通索引
KEY idx_order_id (order_id)
KEY idx_order_no (order_no)
KEY idx_create_time (create_time)
KEY idx_operator_id (operator_id)
KEY idx_to_status (to_status)
```

### inquiry 表索引

```sql
-- 主键索引
PRIMARY KEY (id)

-- 唯一索引
UNIQUE KEY uk_inquiry_no (inquiry_no)

-- 普通索引
KEY idx_order_id (order_id)
KEY idx_supplier_id (supplier_id)
KEY idx_status (status)
KEY idx_deadline (deadline)
KEY idx_supplier_status (supplier_id, status)  -- 组合索引，供应商查询自己的询价单
```

### supplier_quote 表索引

```sql
-- 主键索引
PRIMARY KEY (id)

-- 唯一索引
UNIQUE KEY uk_quote_no (quote_no)

-- 普通索引
KEY idx_inquiry_id (inquiry_id)
KEY idx_order_id (order_id)
KEY idx_supplier_id (supplier_id)
KEY idx_quote_status (quote_status)
KEY idx_submit_time (submit_time)
```

### supplier_quote_item 表索引

```sql
-- 主键索引
PRIMARY KEY (id)

-- 普通索引
KEY idx_quote_id (quote_id)
KEY idx_order_item_id (order_item_id)
KEY idx_part_id (part_id)
```

### purchase_contract 表索引

```sql
-- 主键索引
PRIMARY KEY (id)

-- 唯一索引
UNIQUE KEY uk_contract_no (contract_no)

-- 普通索引
KEY idx_order_id (order_id)
KEY idx_quote_id (quote_id)
KEY idx_supplier_id (supplier_id)
KEY idx_store_id (store_id)
KEY idx_contract_status (contract_status)
KEY idx_create_order_time (create_order_time)
```

### purchase_contract_item 表索引

```sql
-- 主键索引
PRIMARY KEY (id)

-- 普通索引
KEY idx_contract_id (contract_id)
KEY idx_quote_item_id (quote_item_id)
KEY idx_part_id (part_id)
```

---

## 状态流转规则

### 采购单状态流转图

```
[1.草稿]
    ↓ (提交审核)
[2.待审核]
    ↓ (审核通过)              → [4.已驳回] → (修改后重新提交) → [2.待审核]
[3.审核通过]
    ↓ (系统自动操作)
[5.待询价]
    ↓ (供应商报价完成)
[6.已报价]
    ↓ (采购员选择供应商并提交订单)
[7.订单待审核]
    ↓ (审核通过)              → (审核驳回) → [6.已报价]
[8.已下单]
    ↓ (订单完成)
[9.已完成]
```

### 状态变更触发条件

| 当前状态 | 触发动作 | 目标状态 | 操作角色 | 说明 |
| --- | --- | --- | --- | --- |
| 1-草稿 | 提交审核 | 2-待审核 | 采购员 | 提交后不可修改 |
| 2-待审核 | 审核通过 | 3-审核通过 | 审核员 | - |
| 2-待审核 | 审核驳回 | 4-已驳回 | 审核员 | 必须填写驳回理由 |
| 4-已驳回 | 重新提交 | 2-待审核 | 采购员 | 修改后重新提交 |
| 3-审核通过 | 系统自动发送询价 | 5-待询价 | 系统 | 自动匹配供应商 |
| 5-待询价 | 供应商报价完成 | 6-已报价 | 系统 | 所有供应商完成报价或截止时间到 |
| 6-已报价 | 提交订单 | 7-订单待审核 | 采购员 | 选择供应商后生成订单 |
| 7-订单待审核 | 审核通过 | 8-已下单 | 审核员 | 订单正式生效 |
| 7-订单待审核 | 审核驳回 | 6-已报价 | 审核员 | 可重新选择供应商 |
| 8-已下单 | 订单完成 | 9-已完成 | 系统/采购员 | 收货确认后完成 |

### 状态变更日志记录规范

每次状态变更必须在 `purchase_order_status_log` 表中记录：

1. **记录时机**：状态变更后立即记录
2. **事务控制**：状态变更和日志记录在同一事务中
3. **必填字段**：order_id, from_status, to_status, action_type, operator_id, operator_name
4. **扩展数据**：将关键业务数据存储在 extra_data 字段（JSON 格式）

**示例 extra_data 内容**：

```json
{
  "audit_result": "approve",
  "audit_remark": "配件采购合理，批准",
  "old_total_amount": "10000.00",
  "new_total_amount": "9800.00",
  "selected_supplier": {
    "id": 123,
    "name": "XX汽配供应商"
  }
}
```

---

## 数据字典

### 采购单状态枚举 (purchase_order.status)

| 状态码 | 状态名称   | 英文标识            | 说明                             |
| ------ | ---------- | ------------------- | -------------------------------- |
| 1      | 草稿       | DRAFT               | 采购单已创建但未提交             |
| 2      | 待审核     | PENDING_AUDIT       | 采购单已提交，等待审核           |
| 3      | 审核通过   | AUDIT_APPROVED      | 审核通过，等待系统发送询价       |
| 4      | 已驳回     | REJECTED            | 审核被驳回，可修改后重新提交     |
| 5      | 待询价     | PENDING_INQUIRY     | 系统已发送询价，等待供应商报价   |
| 6      | 已报价     | QUOTED              | 供应商已完成报价，可进行比价选择 |
| 7      | 订单待审核 | ORDER_PENDING_AUDIT | 已提交订单，等待最终审核         |
| 8      | 已下单     | ORDERED             | 订单审核通过，已正式下单         |
| 9      | 已完成     | COMPLETED           | 订单履行完成                     |

### 采购类型枚举 (purchase_order.order_type)

| 类型码      | 类型名称 | 说明                       |
| ----------- | -------- | -------------------------- |
| PARTS       | 备件采购 | 标准配件，需要多供应商竞价 |
| ACCESSORIES | 精品采购 | 增值商品，固定价格直接采购 |
| MIXED       | 混合采购 | 同时包含备件和精品         |

### 询价类型枚举 (inquiry.inquiry_type)

| 类型码      | 类型名称 | 说明                           |
| ----------- | -------- | ------------------------------ |
| COMPETITIVE | 竞价询价 | 备件采购，需要多供应商报价比价 |
| DIRECT      | 直接采购 | 精品采购，按固定价格直接下单   |

### 询价状态枚举 (inquiry.status)

| 状态码 | 状态名称 | 说明                         |
| ------ | -------- | ---------------------------- |
| 1      | 待报价   | 询价单已发送，等待供应商报价 |
| 2      | 已报价   | 供应商已完成报价             |
| 3      | 已超时   | 超过报价截止时间未报价       |
| 4      | 已中标   | 该供应商被选中               |
| 5      | 未中标   | 该供应商未被选中             |

### 报价状态枚举 (supplier_quote.quote_status)

| 状态码 | 状态名称 | 说明               |
| ------ | -------- | ------------------ |
| 1      | 草稿     | 供应商保存但未提交 |
| 2      | 已提交   | 供应商已提交报价   |
| 3      | 已中标   | 报价被选中         |
| 4      | 未中标   | 报价未被选中       |

### 订单状态枚举 (purchase_contract.contract_status)

| 状态码 | 状态名称 | 说明                           |
| ------ | -------- | ------------------------------ |
| 1      | 待审核   | 订单已创建，等待审核           |
| 2      | 审核通过 | 订单审核通过，等待发送给供应商 |
| 3      | 已驳回   | 订单审核被驳回                 |
| 4      | 已发货   | 供应商已发货                   |
| 5      | 已收货   | 门店已收货                     |
| 6      | 已完成   | 订单完成                       |
| 7      | 已取消   | 订单取消                       |

### 操作类型枚举 (purchase_order_status_log.action_type)

| 操作码          | 操作名称     | 说明             |
| --------------- | ------------ | ---------------- |
| CREATE          | 创建         | 创建采购单       |
| SUBMIT          | 提交         | 提交采购单审核   |
| APPROVE         | 审核通过     | 审核通过采购单   |
| REJECT          | 驳回         | 驳回采购单       |
| INQUIRY         | 发送询价     | 系统自动发送询价 |
| QUOTE           | 报价完成     | 供应商完成报价   |
| SELECT_SUPPLIER | 选择供应商   | 采购员选择供应商 |
| ORDER_SUBMIT    | 提交订单     | 提交订单审核     |
| ORDER_APPROVE   | 订单审核通过 | 订单审核通过     |
| ORDER_REJECT    | 订单驳回     | 订单审核驳回     |
| COMPLETE        | 完成         | 采购单完成       |

### 操作角色枚举 (purchase_order_status_log.operator_role)

| 角色码    | 角色名称 | 说明              |
| --------- | -------- | ----------------- |
| PURCHASER | 采购员   | 门店采购人员      |
| AUDITOR   | 审核员   | 集团/区域审核人员 |
| SYSTEM    | 系统     | 系统自动操作      |
| SUPPLIER  | 供应商   | 供应商用户        |
| ADMIN     | 管理员   | 系统管理员        |

---

## 表关系图

```
purchase_order (采购单主表)
    ├─→ purchase_order_item (采购单明细表) [1:N]
    │       └─→ selected_quote_item_id → supplier_quote_item (选中的报价明细)
    ├─→ purchase_order_status_log (状态流转记录表) [1:N]
    ├─→ inquiry (询价单表) [1:N]
    │       └─→ supplier_quote (供应商报价表) [1:1]
    │               └─→ supplier_quote_item (报价明细表) [1:N]
    └─→ purchase_contract (采购订单表) [1:N] (支持拆单，一个采购单可能生成多个订单)
            └─→ purchase_contract_item (订单明细表) [1:N]

关键关联：
- purchase_order_item.selected_quote_item_id 关联到 supplier_quote_item.id
- 支持每个配件明细选择不同的供应商（拆单场景）
- 按 selected_supplier_id 分组生成多个采购订单
```

---

## 建表 SQL 示例

### 1. 创建采购单主表

```sql
CREATE TABLE `purchase_order` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `order_no` VARCHAR(32) NOT NULL COMMENT '采购单号',
  `order_type` VARCHAR(20) NOT NULL DEFAULT 'PARTS' COMMENT '采购类型',
  `store_id` BIGINT NOT NULL COMMENT '采购门店ID',
  `store_name` VARCHAR(100) NOT NULL COMMENT '采购门店名称',
  `creator_id` BIGINT NOT NULL COMMENT '创建人ID',
  `creator_name` VARCHAR(50) NOT NULL COMMENT '创建人姓名',
  `expected_delivery_date` DATE NOT NULL COMMENT '期望到货日期',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '当前状态',
  `estimated_amount` DECIMAL(12,2) DEFAULT NULL COMMENT '参考预估金额',
  `lowest_quote_amount` DECIMAL(12,2) DEFAULT NULL COMMENT '最低报价金额',
  `final_amount` DECIMAL(12,2) DEFAULT NULL COMMENT '最终成交金额',
  `remark` TEXT COMMENT '备注说明',
  `submit_time` DATETIME DEFAULT NULL COMMENT '提交审核时间',
  `first_audit_id` BIGINT DEFAULT NULL COMMENT '采购单审核员ID',
  `first_audit_name` VARCHAR(50) DEFAULT NULL COMMENT '采购单审核员姓名',
  `first_audit_time` DATETIME DEFAULT NULL COMMENT '采购单审核时间',
  `first_audit_result` TINYINT DEFAULT NULL COMMENT '采购单审核结果',
  `first_audit_remark` TEXT DEFAULT NULL COMMENT '采购单审核备注',
  `second_audit_id` BIGINT DEFAULT NULL COMMENT '订单审核员ID',
  `second_audit_name` VARCHAR(50) DEFAULT NULL COMMENT '订单审核员姓名',
  `second_audit_time` DATETIME DEFAULT NULL COMMENT '订单审核时间',
  `second_audit_result` TINYINT DEFAULT NULL COMMENT '订单审核结果',
  `second_audit_remark` TEXT DEFAULT NULL COMMENT '订单审核备注',
  `supplier_count` TINYINT DEFAULT 0 COMMENT '选中的供应商数量',
  `contract_count` TINYINT DEFAULT 0 COMMENT '生成的订单数量',
  `inquiry_deadline` DATETIME DEFAULT NULL COMMENT '询价截止时间',
  `completed_time` DATETIME DEFAULT NULL COMMENT '完成时间',
  `is_deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除标识',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_no` (`order_no`),
  KEY `idx_store_id` (`store_id`),
  KEY `idx_creator_id` (`creator_id`),
  KEY `idx_status` (`status`),
  KEY `idx_create_time` (`create_time`),
  KEY `idx_submit_time` (`submit_time`),
  KEY `idx_store_status` (`store_id`, `status`),
  KEY `idx_is_deleted` (`is_deleted`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='采购单主表';
```

### 2. 创建采购单明细表

```sql
CREATE TABLE `purchase_order_item` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `order_id` BIGINT NOT NULL COMMENT '采购单ID',
  `order_no` VARCHAR(32) NOT NULL COMMENT '采购单号',
  `part_id` BIGINT NOT NULL COMMENT '配件ID',
  `part_code` VARCHAR(50) NOT NULL COMMENT '配件编码',
  `part_name` VARCHAR(200) NOT NULL COMMENT '配件名称',
  `part_type` VARCHAR(20) NOT NULL COMMENT '配件类型',
  `specification` VARCHAR(200) DEFAULT NULL COMMENT '规格型号',
  `unit` VARCHAR(20) NOT NULL COMMENT '计量单位',
  `quantity` DECIMAL(10,2) NOT NULL COMMENT '采购数量',
  `historical_avg_price` DECIMAL(10,2) DEFAULT NULL COMMENT '历史平均价格',
  `selected_supplier_id` BIGINT DEFAULT NULL COMMENT '该明细选中的供应商ID',
  `selected_supplier_name` VARCHAR(100) DEFAULT NULL COMMENT '该明细选中的供应商名称',
  `selected_quote_item_id` BIGINT DEFAULT NULL COMMENT '选中的报价明细ID',
  `final_price` DECIMAL(10,2) DEFAULT NULL COMMENT '最终成交单价',
  `final_amount` DECIMAL(12,2) DEFAULT NULL COMMENT '最终成交总价',
  `remark` VARCHAR(500) DEFAULT NULL COMMENT '明细备注',
  `sort_order` INT NOT NULL DEFAULT 0 COMMENT '排序序号',
  `is_deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除标识',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_order_id` (`order_id`),
  KEY `idx_order_no` (`order_no`),
  KEY `idx_part_id` (`part_id`),
  KEY `idx_selected_supplier_id` (`selected_supplier_id`),
  KEY `idx_selected_quote_item_id` (`selected_quote_item_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='采购单明细表';
```

### 3. 创建采购单状态流转记录表

```sql
CREATE TABLE `purchase_order_status_log` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `order_id` BIGINT NOT NULL COMMENT '采购单ID',
  `order_no` VARCHAR(32) NOT NULL COMMENT '采购单号',
  `from_status` TINYINT DEFAULT NULL COMMENT '原状态',
  `to_status` TINYINT NOT NULL COMMENT '目标状态',
  `from_status_name` VARCHAR(20) DEFAULT NULL COMMENT '原状态名称',
  `to_status_name` VARCHAR(20) NOT NULL COMMENT '目标状态名称',
  `action_type` VARCHAR(30) NOT NULL COMMENT '操作类型',
  `operator_id` BIGINT NOT NULL COMMENT '操作人ID',
  `operator_name` VARCHAR(50) NOT NULL COMMENT '操作人姓名',
  `operator_role` VARCHAR(30) NOT NULL COMMENT '操作人角色',
  `remark` TEXT DEFAULT NULL COMMENT '操作备注',
  `extra_data` JSON DEFAULT NULL COMMENT '扩展数据',
  `ip_address` VARCHAR(50) DEFAULT NULL COMMENT '操作IP地址',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
  PRIMARY KEY (`id`),
  KEY `idx_order_id` (`order_id`),
  KEY `idx_order_no` (`order_no`),
  KEY `idx_create_time` (`create_time`),
  KEY `idx_operator_id` (`operator_id`),
  KEY `idx_to_status` (`to_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='采购单状态流转记录表';
```

### 4. 创建询价单表

```sql
CREATE TABLE `inquiry` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `inquiry_no` VARCHAR(32) NOT NULL COMMENT '询价单号',
  `order_id` BIGINT NOT NULL COMMENT '关联的采购单ID',
  `order_no` VARCHAR(32) NOT NULL COMMENT '采购单号',
  `supplier_id` BIGINT NOT NULL COMMENT '供应商ID',
  `supplier_name` VARCHAR(100) NOT NULL COMMENT '供应商名称',
  `inquiry_type` VARCHAR(20) NOT NULL DEFAULT 'COMPETITIVE' COMMENT '询价类型',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '询价状态',
  `deadline` DATETIME NOT NULL COMMENT '报价截止时间',
  `send_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '发送时间',
  `notify_method` VARCHAR(50) DEFAULT NULL COMMENT '通知方式',
  `is_quoted` TINYINT NOT NULL DEFAULT 0 COMMENT '是否已报价',
  `quote_time` DATETIME DEFAULT NULL COMMENT '报价时间',
  `is_selected` TINYINT NOT NULL DEFAULT 0 COMMENT '是否被选中',
  `remark` TEXT DEFAULT NULL COMMENT '备注',
  `is_deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除标识',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_inquiry_no` (`inquiry_no`),
  KEY `idx_order_id` (`order_id`),
  KEY `idx_supplier_id` (`supplier_id`),
  KEY `idx_status` (`status`),
  KEY `idx_deadline` (`deadline`),
  KEY `idx_supplier_status` (`supplier_id`, `status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='询价单表';
```

### 5. 创建供应商报价表

```sql
CREATE TABLE `supplier_quote` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `quote_no` VARCHAR(32) NOT NULL COMMENT '报价单号',
  `inquiry_id` BIGINT NOT NULL COMMENT '询价单ID',
  `inquiry_no` VARCHAR(32) NOT NULL COMMENT '询价单号',
  `order_id` BIGINT NOT NULL COMMENT '采购单ID',
  `order_no` VARCHAR(32) NOT NULL COMMENT '采购单号',
  `supplier_id` BIGINT NOT NULL COMMENT '供应商ID',
  `supplier_name` VARCHAR(100) NOT NULL COMMENT '供应商名称',
  `total_amount` DECIMAL(12,2) NOT NULL COMMENT '报价总金额',
  `expected_delivery_days` INT NOT NULL COMMENT '预计交货天数',
  `expected_delivery_date` DATE NOT NULL COMMENT '预计交货日期',
  `quote_remark` TEXT DEFAULT NULL COMMENT '报价备注说明',
  `validity_days` INT NOT NULL DEFAULT 30 COMMENT '报价有效期（天数）',
  `quote_status` TINYINT NOT NULL DEFAULT 1 COMMENT '报价状态',
  `is_selected` TINYINT NOT NULL DEFAULT 0 COMMENT '是否被选中',
  `submit_time` DATETIME DEFAULT NULL COMMENT '提交报价时间',
  `submit_user_id` BIGINT DEFAULT NULL COMMENT '提交人ID',
  `submit_user_name` VARCHAR(50) DEFAULT NULL COMMENT '提交人姓名',
  `is_deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除标识',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_quote_no` (`quote_no`),
  KEY `idx_inquiry_id` (`inquiry_id`),
  KEY `idx_order_id` (`order_id`),
  KEY `idx_supplier_id` (`supplier_id`),
  KEY `idx_quote_status` (`quote_status`),
  KEY `idx_submit_time` (`submit_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='供应商报价表';
```

### 6. 创建供应商报价明细表

```sql
CREATE TABLE `supplier_quote_item` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `quote_id` BIGINT NOT NULL COMMENT '报价单ID',
  `quote_no` VARCHAR(32) NOT NULL COMMENT '报价单号',
  `order_item_id` BIGINT NOT NULL COMMENT '采购单明细ID',
  `part_id` BIGINT NOT NULL COMMENT '配件ID',
  `part_code` VARCHAR(50) NOT NULL COMMENT '配件编码',
  `part_name` VARCHAR(200) NOT NULL COMMENT '配件名称',
  `specification` VARCHAR(200) DEFAULT NULL COMMENT '规格型号',
  `unit` VARCHAR(20) NOT NULL COMMENT '计量单位',
  `quantity` DECIMAL(10,2) NOT NULL COMMENT '采购数量',
  `quote_price` DECIMAL(10,2) NOT NULL COMMENT '报价单价',
  `quote_amount` DECIMAL(12,2) NOT NULL COMMENT '报价总价',
  `brand` VARCHAR(50) DEFAULT NULL COMMENT '品牌',
  `origin` VARCHAR(50) DEFAULT NULL COMMENT '产地',
  `delivery_days` INT DEFAULT NULL COMMENT '该配件交货天数',
  `remark` VARCHAR(500) DEFAULT NULL COMMENT '明细备注',
  `is_deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除标识',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_quote_id` (`quote_id`),
  KEY `idx_order_item_id` (`order_item_id`),
  KEY `idx_part_id` (`part_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='供应商报价明细表';
```

### 7. 创建采购订单表

```sql
CREATE TABLE `purchase_contract` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `contract_no` VARCHAR(32) NOT NULL COMMENT '采购订单号',
  `order_id` BIGINT NOT NULL COMMENT '采购单ID',
  `order_no` VARCHAR(32) NOT NULL COMMENT '采购单号',
  `quote_id` BIGINT NOT NULL COMMENT '报价单ID',
  `quote_no` VARCHAR(32) NOT NULL COMMENT '报价单号',
  `supplier_id` BIGINT NOT NULL COMMENT '供应商ID',
  `supplier_name` VARCHAR(100) NOT NULL COMMENT '供应商名称',
  `store_id` BIGINT NOT NULL COMMENT '采购门店ID',
  `store_name` VARCHAR(100) NOT NULL COMMENT '采购门店名称',
  `contract_amount` DECIMAL(12,2) NOT NULL COMMENT '订单金额',
  `expected_delivery_date` DATE NOT NULL COMMENT '期望到货日期',
  `contract_status` TINYINT NOT NULL DEFAULT 1 COMMENT '订单状态',
  `creator_id` BIGINT NOT NULL COMMENT '创建人ID',
  `creator_name` VARCHAR(50) NOT NULL COMMENT '创建人姓名',
  `create_order_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '订单创建时间',
  `audit_id` BIGINT DEFAULT NULL COMMENT '审核人ID',
  `audit_name` VARCHAR(50) DEFAULT NULL COMMENT '审核人姓名',
  `audit_time` DATETIME DEFAULT NULL COMMENT '审核时间',
  `audit_result` TINYINT DEFAULT NULL COMMENT '审核结果',
  `audit_remark` TEXT DEFAULT NULL COMMENT '审核备注/驳回理由',
  `send_time` DATETIME DEFAULT NULL COMMENT '发送给供应商时间',
  `delivery_time` DATETIME DEFAULT NULL COMMENT '实际发货时间',
  `receive_time` DATETIME DEFAULT NULL COMMENT '实际收货时间',
  `complete_time` DATETIME DEFAULT NULL COMMENT '完成时间',
  `remark` TEXT DEFAULT NULL COMMENT '订单备注',
  `is_deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除标识',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_contract_no` (`contract_no`),
  KEY `idx_order_id` (`order_id`),
  KEY `idx_quote_id` (`quote_id`),
  KEY `idx_supplier_id` (`supplier_id`),
  KEY `idx_store_id` (`store_id`),
  KEY `idx_contract_status` (`contract_status`),
  KEY `idx_create_order_time` (`create_order_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='采购订单表';
```

### 8. 创建采购订单明细表

```sql
CREATE TABLE `purchase_contract_item` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `contract_id` BIGINT NOT NULL COMMENT '订单ID',
  `contract_no` VARCHAR(32) NOT NULL COMMENT '订单号',
  `quote_item_id` BIGINT NOT NULL COMMENT '报价明细ID',
  `part_id` BIGINT NOT NULL COMMENT '配件ID',
  `part_code` VARCHAR(50) NOT NULL COMMENT '配件编码',
  `part_name` VARCHAR(200) NOT NULL COMMENT '配件名称',
  `specification` VARCHAR(200) DEFAULT NULL COMMENT '规格型号',
  `unit` VARCHAR(20) NOT NULL COMMENT '计量单位',
  `quantity` DECIMAL(10,2) NOT NULL COMMENT '采购数量',
  `contract_price` DECIMAL(10,2) NOT NULL COMMENT '订单单价',
  `contract_amount` DECIMAL(12,2) NOT NULL COMMENT '订单总价',
  `received_quantity` DECIMAL(10,2) NOT NULL DEFAULT 0.00 COMMENT '已收货数量',
  `brand` VARCHAR(50) DEFAULT NULL COMMENT '品牌',
  `origin` VARCHAR(50) DEFAULT NULL COMMENT '产地',
  `remark` VARCHAR(500) DEFAULT NULL COMMENT '明细备注',
  `is_deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除标识',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_contract_id` (`contract_id`),
  KEY `idx_quote_item_id` (`quote_item_id`),
  KEY `idx_part_id` (`part_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='采购订单明细表';
```

---

## 设计说明与注意事项

### 1. 采购单与采购订单分表设计

虽然从 PRD 的状态流转看，采购单和订单似乎是一个连续的流程，但分成两个表有以下考虑：

**业务概念分离：**

- **采购单 (purchase_order)**：采购需求管理，关注"要买什么"
  - 包含完整的询价、报价、比价过程
  - 可能涉及多个供应商
- **采购订单 (purchase_contract)**：采购合同管理，关注"和谁买、怎么履行"
  - 正式的法律文件，有独立的审核流程
  - 涉及发货、收货、结算等后续流程

**扩展性考虑：**

- 未来可能支持一个采购单拆分给多个供应商（不同配件给不同供应商）
- 订单可能需要对接 ERP、财务、物流等外部系统
- 订单有独立的生命周期管理需求

**如果业务简单，也可以合并为一个表**，但建议保留分表设计以应对未来扩展。

### 2. 金额字段设计优化

采购单主表中的三个金额字段有明确的业务含义：

| 字段 | 填充时机 | 用途 | 是否必填 |
| --- | --- | --- | --- |
| estimated_amount | 创建采购单时 | 基于配件历史均价的参考预估，供审核参考 | 否，可为空 |
| lowest_quote_amount | 供应商报价完成后 | 系统自动计算的最低报价，供比价参考 | 否，报价后才有 |
| final_amount | 选择供应商后 | 实际选择的供应商报价，最终成交金额 | 是，生成订单后必填 |

**设计原因：**

- 采购单创建时没有实际价格，只能基于历史数据预估（estimated_amount）
- 供应商报价后会有多个不同报价，系统计算最低价便于采购员快速决策（lowest_quote_amount）
- 采购员可能不选最低价（考虑交期、质量等因素），最终选择的价格记录在 final_amount

这样设计既支持决策参考，又记录了完整的价格变化过程。

### 3. 采购单明细表支持拆单场景

采购单明细表 (purchase_order_item) 的设计支持灵活的供应商选择：

**字段设计说明：**

| 字段 | 用途 | 填充时机 |
| --- | --- | --- |
| historical_avg_price | 历史参考价 | 创建采购单时自动计算，供审核参考 |
| selected_supplier_id | 选中的供应商 | 比价后，可为每个配件选择不同供应商 |
| selected_quote_item_id | 选中的报价明细 | 关联到具体的报价记录，保证可追溯 |
| final_price | 成交单价 | 从选中的报价明细复制，单个配件的单价 |
| final_amount | 成交总价 | final_price × quantity，单个配件的总价 |

**支持的采购场景：**

**场景 1：统一供应商（简单场景）**

```
采购单包含：机油滤清器 × 10、刹车片 × 5、火花塞 × 20
↓
所有配件都选择供应商A
↓
所有明细的 selected_supplier_id 都是 A
```

**场景 2：拆单给多个供应商（复杂场景）**

```
采购单包含：机油滤清器 × 10、刹车片 × 5、火花塞 × 20
↓
比价发现：
- 机油滤清器：供应商A最便宜（50元）
- 刹车片：供应商B质量好且价格合理（200元）
- 火花塞：供应商C交期最快（30元）
↓
明细1：机油滤清器，selected_supplier_id = A，final_price = 50
明细2：刹车片，selected_supplier_id = B，final_price = 200
明细3：火花塞，selected_supplier_id = C，final_price = 30
```

**这种设计的优势：**

- ✅ 每个配件都有明确的单价和总价
- ✅ 支持一个采购单拆分给多个供应商
- ✅ 可以针对每个配件选择最优供应商
- ✅ 通过 selected_quote_item_id 完整追溯选择依据

**采购订单生成逻辑：**

- 按 selected_supplier_id 分组，同一供应商的配件生成一个采购订单
- 如果选了 3 个供应商，就生成 3 个采购订单
- 每个订单只包含该供应商对应的配件明细

### 4. 冗余字段设计

在主表中适当冗余了一些常用字段（如门店名称、创建人姓名等），原因：

- **查询性能**：避免大量 JOIN 操作，提升列表查询效率
- **数据稳定性**：即使关联表数据变更，历史记录仍保持一致
- **业务便利性**：便于数据导出和报表展示

### 5. 状态流转设计

- 采用主表维护当前状态 + 流转日志表记录历史的模式
- 确保状态变更的完整追溯能力
- extra_data 字段使用 JSON 类型存储扩展信息，增强灵活性

### 6. 双重审核机制

设计了两轮审核：

- **第一轮审核**：采购需求的合理性审核（first*audit*\*字段）
- **第二轮审核**：订单和供应商选择的审核（second*audit*\*字段）

### 7. 逻辑删除

所有主表采用逻辑删除（is_deleted 字段），确保：

- 历史数据可追溯
- 避免级联删除风险
- 支持数据恢复

### 8. 索引优化策略

- 单字段索引：用于单一条件查询
- 组合索引：用于常见的多条件查询场景（如门店+状态）
- 避免过度索引：平衡查询性能和写入性能

### 9. 扩展性考虑

- 预留了多个可选字段，支持业务扩展
- extra_data JSON 字段可存储非结构化扩展数据
- 状态码和类型码设计预留了足够的扩展空间

---

## 常用查询示例

### 1. 查询采购单及其明细（最基础）

```sql
-- 查询单个采购单的所有明细
SELECT
    po.order_no,
    po.store_name,
    po.creator_name,
    po.status,
    poi.part_code,
    poi.part_name,
    poi.quantity,
    poi.unit,
    poi.historical_avg_price,
    poi.final_price,
    poi.final_amount,
    poi.selected_supplier_name
FROM purchase_order po
LEFT JOIN purchase_order_item poi ON po.id = poi.order_id
WHERE po.order_no = 'PO2024101500001'
  AND po.is_deleted = 0
  AND poi.is_deleted = 0
ORDER BY poi.sort_order;
```

### 2. 查询采购单及明细（分组统计）

```sql
-- 查询采购单基本信息及配件数量统计
SELECT
    po.order_no,
    po.store_name,
    po.creator_name,
    po.status,
    po.expected_delivery_date,
    po.estimated_amount,
    po.final_amount,
    COUNT(poi.id) as item_count,
    SUM(poi.quantity) as total_quantity,
    po.supplier_count,
    po.create_time
FROM purchase_order po
LEFT JOIN purchase_order_item poi ON po.id = poi.order_id AND poi.is_deleted = 0
WHERE po.is_deleted = 0
GROUP BY po.id
ORDER BY po.create_time DESC;
```

### 3. 查询采购单明细及报价信息（比价场景）

```sql
-- 查询某个采购单的所有配件及其各供应商报价
SELECT
    poi.part_code,
    poi.part_name,
    poi.quantity,
    poi.historical_avg_price as reference_price,
    s.supplier_name,
    sqi.quote_price,
    sqi.quote_amount,
    sq.expected_delivery_days,
    CASE
        WHEN poi.selected_quote_item_id = sqi.id THEN '已选中'
        ELSE ''
    END as is_selected
FROM purchase_order_item poi
LEFT JOIN supplier_quote_item sqi ON sqi.order_item_id = poi.id AND sqi.is_deleted = 0
LEFT JOIN supplier_quote sq ON sqi.quote_id = sq.id AND sq.is_deleted = 0
LEFT JOIN (
    -- 这里需要关联供应商表（示例用子查询模拟）
    SELECT id as supplier_id, name as supplier_name FROM suppliers
) s ON sq.supplier_id = s.supplier_id
WHERE poi.order_id = (SELECT id FROM purchase_order WHERE order_no = 'PO2024101500001')
  AND poi.is_deleted = 0
ORDER BY poi.sort_order, sqi.quote_price ASC;
```

### 4. 查询拆单明细（按供应商分组）

```sql
-- 查询采购单按供应商分组的明细（查看拆单情况）
SELECT
    po.order_no,
    poi.selected_supplier_id,
    poi.selected_supplier_name,
    COUNT(poi.id) as item_count,
    SUM(poi.final_amount) as supplier_total_amount,
    GROUP_CONCAT(CONCAT(poi.part_name, ' x', poi.quantity) SEPARATOR '; ') as parts_summary
FROM purchase_order po
INNER JOIN purchase_order_item poi ON po.id = poi.order_id
WHERE po.order_no = 'PO2024101500001'
  AND po.is_deleted = 0
  AND poi.is_deleted = 0
  AND poi.selected_supplier_id IS NOT NULL
GROUP BY po.order_no, poi.selected_supplier_id, poi.selected_supplier_name;
```

### 5. 查询采购单完整信息（含状态流转）

```sql
-- 查询采购单的完整信息（基本信息 + 明细 + 状态流转）
-- 分三步查询：

-- 步骤1：查询采购单基本信息
SELECT * FROM purchase_order
WHERE order_no = 'PO2024101500001' AND is_deleted = 0;

-- 步骤2：查询配件明细
SELECT
    part_code,
    part_name,
    specification,
    quantity,
    unit,
    historical_avg_price,
    selected_supplier_name,
    final_price,
    final_amount,
    remark
FROM purchase_order_item
WHERE order_no = 'PO2024101500001' AND is_deleted = 0
ORDER BY sort_order;

-- 步骤3：查询状态流转记录
SELECT
    from_status_name,
    to_status_name,
    action_type,
    operator_name,
    operator_role,
    remark,
    create_time
FROM purchase_order_status_log
WHERE order_no = 'PO2024101500001'
ORDER BY create_time ASC;
```

### 6. 列表查询（带分页）

```sql
-- 采购单列表查询（分页、筛选）
SELECT
    po.order_no,
    po.store_name,
    po.creator_name,
    po.expected_delivery_date,
    po.status,
    CASE po.status
        WHEN 1 THEN '草稿'
        WHEN 2 THEN '待审核'
        WHEN 3 THEN '审核通过'
        WHEN 4 THEN '已驳回'
        WHEN 5 THEN '待询价'
        WHEN 6 THEN '已报价'
        WHEN 7 THEN '订单待审核'
        WHEN 8 THEN '已下单'
        WHEN 9 THEN '已完成'
    END as status_name,
    po.final_amount,
    po.supplier_count,
    COUNT(poi.id) as item_count,
    po.create_time,
    po.submit_time
FROM purchase_order po
LEFT JOIN purchase_order_item poi ON po.id = poi.order_id AND poi.is_deleted = 0
WHERE po.is_deleted = 0
  -- 筛选条件示例
  AND (po.store_id = ? OR ? IS NULL)  -- 门店筛选
  AND (po.status = ? OR ? IS NULL)    -- 状态筛选
  AND (po.creator_id = ? OR ? IS NULL)  -- 创建人筛选
  AND (po.create_time >= ? OR ? IS NULL)  -- 开始日期
  AND (po.create_time <= ? OR ? IS NULL)  -- 结束日期
  AND (po.order_no LIKE CONCAT('%', ?, '%') OR ? IS NULL)  -- 采购单号模糊搜索
GROUP BY po.id
ORDER BY po.create_time DESC
LIMIT ? OFFSET ?;  -- 分页参数
```

### 7. 采购单权限查询（角色视图）

```sql
-- 采购员查看自己创建的采购单
SELECT
    po.order_no,
    po.status,
    po.final_amount,
    COUNT(poi.id) as item_count,
    po.create_time
FROM purchase_order po
LEFT JOIN purchase_order_item poi ON po.id = poi.order_id AND poi.is_deleted = 0
WHERE po.creator_id = ?  -- 当前登录采购员ID
  AND po.is_deleted = 0
GROUP BY po.id
ORDER BY po.create_time DESC;

-- 审核员查看待审核的采购单
SELECT
    po.order_no,
    po.store_name,
    po.creator_name,
    po.status,
    po.estimated_amount,
    po.submit_time,
    COUNT(poi.id) as item_count
FROM purchase_order po
LEFT JOIN purchase_order_item poi ON po.id = poi.order_id AND poi.is_deleted = 0
WHERE po.status IN (2, 7)  -- 2-待审核, 7-订单待审核
  AND po.is_deleted = 0
GROUP BY po.id
ORDER BY po.submit_time ASC;
```

### 8. 统计查询示例

```sql
-- 统计某门店的采购情况
SELECT
    po.store_name,
    COUNT(DISTINCT po.id) as total_orders,
    COUNT(DISTINCT CASE WHEN po.status = 9 THEN po.id END) as completed_orders,
    COUNT(DISTINCT poi.id) as total_items,
    SUM(poi.final_amount) as total_amount,
    AVG(DATEDIFF(po.completed_time, po.create_time)) as avg_completion_days
FROM purchase_order po
LEFT JOIN purchase_order_item poi ON po.id = poi.order_id AND poi.is_deleted = 0
WHERE po.store_id = ?
  AND po.is_deleted = 0
  AND po.create_time >= DATE_SUB(NOW(), INTERVAL 30 DAY)  -- 最近30天
GROUP BY po.store_id, po.store_name;
```

### 9. 查询配件明细关联到报价（完整追溯链路）

```sql
-- 查询配件从需求到成交的完整价格链路
SELECT
    po.order_no,
    poi.part_code,
    poi.part_name,
    poi.quantity,
    poi.historical_avg_price,  -- 历史参考价
    poi.selected_supplier_name,  -- 选中的供应商
    sqi.quote_price as selected_quote_price,  -- 选中的报价单价
    poi.final_price,  -- 最终成交单价（应该等于 selected_quote_price）
    poi.final_amount,  -- 最终成交总价
    sq.expected_delivery_days,  -- 交货天数
    sq.submit_time as quote_submit_time  -- 报价时间
FROM purchase_order po
INNER JOIN purchase_order_item poi ON po.id = poi.order_id
LEFT JOIN supplier_quote_item sqi ON poi.selected_quote_item_id = sqi.id
LEFT JOIN supplier_quote sq ON sqi.quote_id = sq.id
WHERE po.order_no = 'PO2024101500001'
  AND po.is_deleted = 0
  AND poi.is_deleted = 0
ORDER BY poi.sort_order;
```

### 10. 查询特定供应商的订单（供应商视图）

```sql
-- 供应商查看自己中标的采购单明细
SELECT
    po.order_no,
    po.store_name,
    poi.part_code,
    poi.part_name,
    poi.quantity,
    poi.final_price,
    poi.final_amount,
    po.status,
    po.expected_delivery_date
FROM purchase_order po
INNER JOIN purchase_order_item poi ON po.id = poi.order_id
WHERE poi.selected_supplier_id = ?  -- 供应商ID
  AND po.is_deleted = 0
  AND poi.is_deleted = 0
  AND po.status >= 7  -- 订单待审核及之后的状态
ORDER BY po.create_time DESC;
```

---

## 查询性能优化建议

### 1. 使用索引

上述查询已经利用了设计的索引：

- `purchase_order.order_no` (唯一索引)
- `purchase_order_item.order_id` (普通索引)
- `purchase_order_item.selected_supplier_id` (普通索引)
- `purchase_order.status` (普通索引)

### 2. 避免 N+1 查询

在应用层查询时，推荐：

```javascript
// ❌ 不好的做法（N+1查询）
const orders = await db.query('SELECT * FROM purchase_order');
for (let order of orders) {
  order.items = await db.query(
    'SELECT * FROM purchase_order_item WHERE order_id = ?',
    [order.id],
  );
}

// ✅ 好的做法（JOIN查询）
const result = await db.query(`
    SELECT 
        po.*,
        poi.id as item_id,
        poi.part_code,
        poi.part_name,
        poi.quantity,
        poi.final_price
    FROM purchase_order po
    LEFT JOIN purchase_order_item poi ON po.id = poi.order_id
    WHERE po.is_deleted = 0 AND poi.is_deleted = 0
`);
// 在应用层组装数据
```

### 3. 分页查询注意事项

```sql
-- 大数据量时，使用 id 范围分页性能更好
SELECT * FROM purchase_order
WHERE id > ? AND is_deleted = 0
ORDER BY id ASC
LIMIT 20;

-- 而不是使用 OFFSET（数据量大时性能差）
SELECT * FROM purchase_order
WHERE is_deleted = 0
ORDER BY id ASC
LIMIT 20 OFFSET 10000;  -- 性能较差
```

### 4. 统计查询优化

对于大数据量的统计，考虑：

- 建立汇总表（定时统计）
- 使用物化视图
- 添加必要的覆盖索引

---

## 完整建表脚本

以下是完整的建表脚本，可直接复制执行（建议按顺序执行）：

```sql
-- ==========================================
-- 奥吉通集团配件集采系统 - 数据库建表脚本
-- 版本: 1.0
-- 日期: 2024-10-15
-- ==========================================

-- 设置字符集
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- ==========================================
-- 1. 采购单主表
-- ==========================================
DROP TABLE IF EXISTS `purchase_order`;
CREATE TABLE `purchase_order` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `order_no` VARCHAR(32) NOT NULL COMMENT '采购单号',
  `order_type` VARCHAR(20) NOT NULL DEFAULT 'PARTS' COMMENT '采购类型',
  `store_id` BIGINT NOT NULL COMMENT '采购门店ID',
  `store_name` VARCHAR(100) NOT NULL COMMENT '采购门店名称',
  `creator_id` BIGINT NOT NULL COMMENT '创建人ID',
  `creator_name` VARCHAR(50) NOT NULL COMMENT '创建人姓名',
  `expected_delivery_date` DATE NOT NULL COMMENT '期望到货日期',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '当前状态',
  `estimated_amount` DECIMAL(12,2) DEFAULT NULL COMMENT '参考预估金额',
  `lowest_quote_amount` DECIMAL(12,2) DEFAULT NULL COMMENT '最低报价金额',
  `final_amount` DECIMAL(12,2) DEFAULT NULL COMMENT '最终成交金额',
  `remark` TEXT COMMENT '备注说明',
  `submit_time` DATETIME DEFAULT NULL COMMENT '提交审核时间',
  `first_audit_id` BIGINT DEFAULT NULL COMMENT '采购单审核员ID',
  `first_audit_name` VARCHAR(50) DEFAULT NULL COMMENT '采购单审核员姓名',
  `first_audit_time` DATETIME DEFAULT NULL COMMENT '采购单审核时间',
  `first_audit_result` TINYINT DEFAULT NULL COMMENT '采购单审核结果',
  `first_audit_remark` TEXT DEFAULT NULL COMMENT '采购单审核备注',
  `second_audit_id` BIGINT DEFAULT NULL COMMENT '订单审核员ID',
  `second_audit_name` VARCHAR(50) DEFAULT NULL COMMENT '订单审核员姓名',
  `second_audit_time` DATETIME DEFAULT NULL COMMENT '订单审核时间',
  `second_audit_result` TINYINT DEFAULT NULL COMMENT '订单审核结果',
  `second_audit_remark` TEXT DEFAULT NULL COMMENT '订单审核备注',
  `supplier_count` TINYINT DEFAULT 0 COMMENT '选中的供应商数量',
  `contract_count` TINYINT DEFAULT 0 COMMENT '生成的订单数量',
  `inquiry_deadline` DATETIME DEFAULT NULL COMMENT '询价截止时间',
  `completed_time` DATETIME DEFAULT NULL COMMENT '完成时间',
  `is_deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除标识',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_no` (`order_no`),
  KEY `idx_store_id` (`store_id`),
  KEY `idx_creator_id` (`creator_id`),
  KEY `idx_status` (`status`),
  KEY `idx_create_time` (`create_time`),
  KEY `idx_submit_time` (`submit_time`),
  KEY `idx_store_status` (`store_id`, `status`),
  KEY `idx_is_deleted` (`is_deleted`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='采购单主表';

-- ==========================================
-- 2. 采购单明细表
-- ==========================================
DROP TABLE IF EXISTS `purchase_order_item`;
CREATE TABLE `purchase_order_item` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `order_id` BIGINT NOT NULL COMMENT '采购单ID',
  `order_no` VARCHAR(32) NOT NULL COMMENT '采购单号',
  `part_id` BIGINT NOT NULL COMMENT '配件ID',
  `part_code` VARCHAR(50) NOT NULL COMMENT '配件编码',
  `part_name` VARCHAR(200) NOT NULL COMMENT '配件名称',
  `part_type` VARCHAR(20) NOT NULL COMMENT '配件类型',
  `specification` VARCHAR(200) DEFAULT NULL COMMENT '规格型号',
  `unit` VARCHAR(20) NOT NULL COMMENT '计量单位',
  `quantity` DECIMAL(10,2) NOT NULL COMMENT '采购数量',
  `historical_avg_price` DECIMAL(10,2) DEFAULT NULL COMMENT '历史平均价格',
  `selected_supplier_id` BIGINT DEFAULT NULL COMMENT '该明细选中的供应商ID',
  `selected_supplier_name` VARCHAR(100) DEFAULT NULL COMMENT '该明细选中的供应商名称',
  `selected_quote_item_id` BIGINT DEFAULT NULL COMMENT '选中的报价明细ID',
  `final_price` DECIMAL(10,2) DEFAULT NULL COMMENT '最终成交单价',
  `final_amount` DECIMAL(12,2) DEFAULT NULL COMMENT '最终成交总价',
  `remark` VARCHAR(500) DEFAULT NULL COMMENT '明细备注',
  `sort_order` INT NOT NULL DEFAULT 0 COMMENT '排序序号',
  `is_deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除标识',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_order_id` (`order_id`),
  KEY `idx_order_no` (`order_no`),
  KEY `idx_part_id` (`part_id`),
  KEY `idx_selected_supplier_id` (`selected_supplier_id`),
  KEY `idx_selected_quote_item_id` (`selected_quote_item_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='采购单明细表';

-- ==========================================
-- 3. 采购单状态流转记录表
-- ==========================================
DROP TABLE IF EXISTS `purchase_order_status_log`;
CREATE TABLE `purchase_order_status_log` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `order_id` BIGINT NOT NULL COMMENT '采购单ID',
  `order_no` VARCHAR(32) NOT NULL COMMENT '采购单号',
  `from_status` TINYINT DEFAULT NULL COMMENT '原状态',
  `to_status` TINYINT NOT NULL COMMENT '目标状态',
  `from_status_name` VARCHAR(20) DEFAULT NULL COMMENT '原状态名称',
  `to_status_name` VARCHAR(20) NOT NULL COMMENT '目标状态名称',
  `action_type` VARCHAR(30) NOT NULL COMMENT '操作类型',
  `operator_id` BIGINT NOT NULL COMMENT '操作人ID',
  `operator_name` VARCHAR(50) NOT NULL COMMENT '操作人姓名',
  `operator_role` VARCHAR(30) NOT NULL COMMENT '操作人角色',
  `remark` TEXT DEFAULT NULL COMMENT '操作备注',
  `extra_data` JSON DEFAULT NULL COMMENT '扩展数据',
  `ip_address` VARCHAR(50) DEFAULT NULL COMMENT '操作IP地址',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
  PRIMARY KEY (`id`),
  KEY `idx_order_id` (`order_id`),
  KEY `idx_order_no` (`order_no`),
  KEY `idx_create_time` (`create_time`),
  KEY `idx_operator_id` (`operator_id`),
  KEY `idx_to_status` (`to_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='采购单状态流转记录表';

-- ==========================================
-- 4. 询价单表
-- ==========================================
DROP TABLE IF EXISTS `inquiry`;
CREATE TABLE `inquiry` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `inquiry_no` VARCHAR(32) NOT NULL COMMENT '询价单号',
  `order_id` BIGINT NOT NULL COMMENT '关联的采购单ID',
  `order_no` VARCHAR(32) NOT NULL COMMENT '采购单号',
  `supplier_id` BIGINT NOT NULL COMMENT '供应商ID',
  `supplier_name` VARCHAR(100) NOT NULL COMMENT '供应商名称',
  `inquiry_type` VARCHAR(20) NOT NULL DEFAULT 'COMPETITIVE' COMMENT '询价类型',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '询价状态',
  `deadline` DATETIME NOT NULL COMMENT '报价截止时间',
  `send_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '发送时间',
  `notify_method` VARCHAR(50) DEFAULT NULL COMMENT '通知方式',
  `is_quoted` TINYINT NOT NULL DEFAULT 0 COMMENT '是否已报价',
  `quote_time` DATETIME DEFAULT NULL COMMENT '报价时间',
  `is_selected` TINYINT NOT NULL DEFAULT 0 COMMENT '是否被选中',
  `remark` TEXT DEFAULT NULL COMMENT '备注',
  `is_deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除标识',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_inquiry_no` (`inquiry_no`),
  KEY `idx_order_id` (`order_id`),
  KEY `idx_supplier_id` (`supplier_id`),
  KEY `idx_status` (`status`),
  KEY `idx_deadline` (`deadline`),
  KEY `idx_supplier_status` (`supplier_id`, `status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='询价单表';

-- ==========================================
-- 5. 供应商报价表
-- ==========================================
DROP TABLE IF EXISTS `supplier_quote`;
CREATE TABLE `supplier_quote` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `quote_no` VARCHAR(32) NOT NULL COMMENT '报价单号',
  `inquiry_id` BIGINT NOT NULL COMMENT '询价单ID',
  `inquiry_no` VARCHAR(32) NOT NULL COMMENT '询价单号',
  `order_id` BIGINT NOT NULL COMMENT '采购单ID',
  `order_no` VARCHAR(32) NOT NULL COMMENT '采购单号',
  `supplier_id` BIGINT NOT NULL COMMENT '供应商ID',
  `supplier_name` VARCHAR(100) NOT NULL COMMENT '供应商名称',
  `total_amount` DECIMAL(12,2) NOT NULL COMMENT '报价总金额',
  `expected_delivery_days` INT NOT NULL COMMENT '预计交货天数',
  `expected_delivery_date` DATE NOT NULL COMMENT '预计交货日期',
  `quote_remark` TEXT DEFAULT NULL COMMENT '报价备注说明',
  `validity_days` INT NOT NULL DEFAULT 30 COMMENT '报价有效期（天数）',
  `quote_status` TINYINT NOT NULL DEFAULT 1 COMMENT '报价状态',
  `is_selected` TINYINT NOT NULL DEFAULT 0 COMMENT '是否被选中',
  `submit_time` DATETIME DEFAULT NULL COMMENT '提交报价时间',
  `submit_user_id` BIGINT DEFAULT NULL COMMENT '提交人ID',
  `submit_user_name` VARCHAR(50) DEFAULT NULL COMMENT '提交人姓名',
  `is_deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除标识',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_quote_no` (`quote_no`),
  KEY `idx_inquiry_id` (`inquiry_id`),
  KEY `idx_order_id` (`order_id`),
  KEY `idx_supplier_id` (`supplier_id`),
  KEY `idx_quote_status` (`quote_status`),
  KEY `idx_submit_time` (`submit_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='供应商报价表';

-- ==========================================
-- 6. 供应商报价明细表
-- ==========================================
DROP TABLE IF EXISTS `supplier_quote_item`;
CREATE TABLE `supplier_quote_item` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `quote_id` BIGINT NOT NULL COMMENT '报价单ID',
  `quote_no` VARCHAR(32) NOT NULL COMMENT '报价单号',
  `order_item_id` BIGINT NOT NULL COMMENT '采购单明细ID',
  `part_id` BIGINT NOT NULL COMMENT '配件ID',
  `part_code` VARCHAR(50) NOT NULL COMMENT '配件编码',
  `part_name` VARCHAR(200) NOT NULL COMMENT '配件名称',
  `specification` VARCHAR(200) DEFAULT NULL COMMENT '规格型号',
  `unit` VARCHAR(20) NOT NULL COMMENT '计量单位',
  `quantity` DECIMAL(10,2) NOT NULL COMMENT '采购数量',
  `quote_price` DECIMAL(10,2) NOT NULL COMMENT '报价单价',
  `quote_amount` DECIMAL(12,2) NOT NULL COMMENT '报价总价',
  `brand` VARCHAR(50) DEFAULT NULL COMMENT '品牌',
  `origin` VARCHAR(50) DEFAULT NULL COMMENT '产地',
  `delivery_days` INT DEFAULT NULL COMMENT '该配件交货天数',
  `remark` VARCHAR(500) DEFAULT NULL COMMENT '明细备注',
  `is_deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除标识',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_quote_id` (`quote_id`),
  KEY `idx_order_item_id` (`order_item_id`),
  KEY `idx_part_id` (`part_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='供应商报价明细表';

-- ==========================================
-- 7. 采购订单表
-- ==========================================
DROP TABLE IF EXISTS `purchase_contract`;
CREATE TABLE `purchase_contract` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `contract_no` VARCHAR(32) NOT NULL COMMENT '采购订单号',
  `order_id` BIGINT NOT NULL COMMENT '采购单ID',
  `order_no` VARCHAR(32) NOT NULL COMMENT '采购单号',
  `quote_id` BIGINT NOT NULL COMMENT '报价单ID',
  `quote_no` VARCHAR(32) NOT NULL COMMENT '报价单号',
  `supplier_id` BIGINT NOT NULL COMMENT '供应商ID',
  `supplier_name` VARCHAR(100) NOT NULL COMMENT '供应商名称',
  `store_id` BIGINT NOT NULL COMMENT '采购门店ID',
  `store_name` VARCHAR(100) NOT NULL COMMENT '采购门店名称',
  `contract_amount` DECIMAL(12,2) NOT NULL COMMENT '订单金额',
  `expected_delivery_date` DATE NOT NULL COMMENT '期望到货日期',
  `contract_status` TINYINT NOT NULL DEFAULT 1 COMMENT '订单状态',
  `creator_id` BIGINT NOT NULL COMMENT '创建人ID',
  `creator_name` VARCHAR(50) NOT NULL COMMENT '创建人姓名',
  `create_order_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '订单创建时间',
  `audit_id` BIGINT DEFAULT NULL COMMENT '审核人ID',
  `audit_name` VARCHAR(50) DEFAULT NULL COMMENT '审核人姓名',
  `audit_time` DATETIME DEFAULT NULL COMMENT '审核时间',
  `audit_result` TINYINT DEFAULT NULL COMMENT '审核结果',
  `audit_remark` TEXT DEFAULT NULL COMMENT '审核备注/驳回理由',
  `send_time` DATETIME DEFAULT NULL COMMENT '发送给供应商时间',
  `delivery_time` DATETIME DEFAULT NULL COMMENT '实际发货时间',
  `receive_time` DATETIME DEFAULT NULL COMMENT '实际收货时间',
  `complete_time` DATETIME DEFAULT NULL COMMENT '完成时间',
  `remark` TEXT DEFAULT NULL COMMENT '订单备注',
  `is_deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除标识',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_contract_no` (`contract_no`),
  KEY `idx_order_id` (`order_id`),
  KEY `idx_quote_id` (`quote_id`),
  KEY `idx_supplier_id` (`supplier_id`),
  KEY `idx_store_id` (`store_id`),
  KEY `idx_contract_status` (`contract_status`),
  KEY `idx_create_order_time` (`create_order_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='采购订单表';

-- ==========================================
-- 8. 采购订单明细表
-- ==========================================
DROP TABLE IF EXISTS `purchase_contract_item`;
CREATE TABLE `purchase_contract_item` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `contract_id` BIGINT NOT NULL COMMENT '订单ID',
  `contract_no` VARCHAR(32) NOT NULL COMMENT '订单号',
  `quote_item_id` BIGINT NOT NULL COMMENT '报价明细ID',
  `part_id` BIGINT NOT NULL COMMENT '配件ID',
  `part_code` VARCHAR(50) NOT NULL COMMENT '配件编码',
  `part_name` VARCHAR(200) NOT NULL COMMENT '配件名称',
  `specification` VARCHAR(200) DEFAULT NULL COMMENT '规格型号',
  `unit` VARCHAR(20) NOT NULL COMMENT '计量单位',
  `quantity` DECIMAL(10,2) NOT NULL COMMENT '采购数量',
  `contract_price` DECIMAL(10,2) NOT NULL COMMENT '订单单价',
  `contract_amount` DECIMAL(12,2) NOT NULL COMMENT '订单总价',
  `received_quantity` DECIMAL(10,2) NOT NULL DEFAULT 0.00 COMMENT '已收货数量',
  `brand` VARCHAR(50) DEFAULT NULL COMMENT '品牌',
  `origin` VARCHAR(50) DEFAULT NULL COMMENT '产地',
  `remark` VARCHAR(500) DEFAULT NULL COMMENT '明细备注',
  `is_deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除标识',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_contract_id` (`contract_id`),
  KEY `idx_quote_item_id` (`quote_item_id`),
  KEY `idx_part_id` (`part_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='采购订单明细表';

SET FOREIGN_KEY_CHECKS = 1;

-- ==========================================
-- 建表脚本执行完成
-- ==========================================
```

---

## 版本历史

| 版本 | 日期       | 修订人       | 修订内容                             |
| ---- | ---------- | ------------ | ------------------------------------ |
| 1.0  | 2024-10-15 | 系统设计团队 | 初始版本，完成核心表结构设计         |
| 1.1  | 2024-10-15 | 系统设计团队 | 新增常用查询示例和性能优化建议       |
| 1.2  | 2024-10-15 | 系统设计团队 | 补充完整的 8 张表建表 SQL 和完整脚本 |

---

**文档结束**

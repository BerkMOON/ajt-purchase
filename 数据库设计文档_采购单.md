# 奥吉通集团配件集采系统 - 数据库设计文档（采购单模块）

**版本：** 1.0 **日期：** 2025-11-20 **文档状态：** 正式版

---

## 1. 概述

本文档定义了采购单模块的核心数据表结构，包括采购单主表和采购单明细表。

### 1.1 设计原则

- **主键策略**：使用自增 ID 作为数据库主键，业务单号作为业务主键
- **软删除**：采用 `is_deleted` 字段实现软删除
- **时间戳**：统一使用 `ctime` 和 `mtime` 记录创建和更新时间
- **状态管理**：采购单状态采用整型枚举
- **数据类型**：金额使用 `decimal(10,2)`，时间使用 `datetime`

### 1.2 命名规范

- 表名：`tb_` + 业务名称，使用下划线分隔单词
- 字段名：使用小写字母和下划线，语义清晰
- 索引名：`idx_` + 表名简称 + 字段名
- 唯一索引：`uk_` + 表名简称 + 字段名

---

## 2. 采购单主表

### 2.1 表名

`tb_purchase_order`

### 2.2 表说明

存储采购单的基本信息，一个采购单对应多个采购明细。

### 2.3 表结构

| 字段名 | 数据类型 | 是否为空 | 默认值 | 说明 |
| --- | --- | --- | --- | --- |
| id | bigint | NOT NULL | 自增 | 主键 ID |
| order_no | bigint | NOT NULL | 0 | 采购单号（业务主键，int64） |
| store_id | bigint | NOT NULL | 0 | 采购门店 ID |
| creator_id | bigint | NOT NULL | 0 | 创建人 ID（采购员 ID） |
| expected_delivery_date | datetime | NOT NULL | '1970-01-01 00:00:00' | 期望到货日期（业务仅使用日期部分） |
| inquiry_deadline | datetime | NOT NULL | '1970-01-01 00:00:00' | 询价截止时间 |
| remark | varchar(500) | NOT NULL | '' | 备注说明 |
| status | int | NOT NULL | 0 | 采购单状态（见状态枚举） |
| order_type | tinyint | NOT NULL | 0 | 订单类型（默认备品，可拓展） |
| is_deleted | tinyint | NOT NULL | 0 | 是否删除（0-未删除，1-已删除） |
| ctime | datetime | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| mtime | datetime | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 2.4 索引设计

| 索引名称       | 索引类型 | 字段     | 说明         |
| -------------- | -------- | -------- | ------------ |
| PRIMARY        | 主键     | id       | 主键索引     |
| uk_po_order_no | 唯一索引 | order_no | 采购单号唯一 |

### 2.5 状态枚举

| 状态码 | 状态名称 | 说明 |
| --- | --- | --- |
| 0 | 草稿 | 采购单已创建但未提交（存储在 Redis 中） |
| 1 | 待审核 | 采购单已提交，等待审核 |
| 2 | 审核驳回 | 采购单审核未通过 |
| 3 | 询价中 | 审核通过，系统已发送询价；包含供应商报价和采购员查看对比阶段 |
| 4 | 已选择报价 | 采购员已确认选择某个供应商的报价，进入价格审批或下单流程 |
| 5 | 价格待审批 | 选中报价超过采购均价，需审批 |
| 6 | 价格审批驳回 | 价格审批未通过 |
| 7 | 已下单 | 已提交订单，正式下单 |
| 8 | 已到货 | 采购员确认到货，记录到货时间 |

### 2.6 建表 SQL

```sql
CREATE TABLE `tb_purchase_order` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `order_no` bigint NOT NULL DEFAULT '0' COMMENT '采购单号',
  `store_id` bigint NOT NULL DEFAULT '0' COMMENT '采购门店ID',
  `creator_id` bigint NOT NULL DEFAULT '0' COMMENT '创建人ID',
  `expected_delivery_date` datetime NOT NULL DEFAULT '1970-01-01 00:00:00' COMMENT '期望到货日期',
  `inquiry_deadline` datetime NOT NULL DEFAULT '1970-01-01 00:00:00' COMMENT '询价截止时间',
  `remark` varchar(500) NOT NULL DEFAULT '' COMMENT '备注说明',
  `status` int NOT NULL DEFAULT '0' COMMENT '采购单状态',
  `order_type` tinyint NOT NULL DEFAULT '0' COMMENT '订单类型',
  `is_deleted` tinyint NOT NULL DEFAULT '0' COMMENT '是否删除',
  `ctime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_po_order_no` (`order_no`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='采购单主表';
```

### 2.7 字段说明补充

**订单号生成规则：**

- 使用 `NewIdGenerator` 生成唯一 ID
- BizName: `purchase_order`
- BizPrefix: `10`
- 时间模式：`TimeModeDatePlusSeconds`（DateFormat=`"060102"`，SeqWidth=`4`）
- 结果为 17 位 `int64`，示例：`10251121495060001`

**草稿状态说明：**

- 状态为 0（草稿）的采购单数据存储在 Redis 中，不写入 MySQL
- Redis key 格式：`ajt:purchase:draft:{creator_id}:{store_id}`，同一用户同一门店仅保留一份草稿
- Redis 数据结构示例：
  ```json
  {
    "store_id": 2001,
    "creator_id": 9527,
    "expected_delivery_date": "2025-12-01",
    "inquiry_deadline": "2025-11-23T18:00:00+08:00",
    "remark": "到店快递件",
    "order_type": 1,
    "items": [
      {
        "sku_id": "80000001",
        "product_name": "机油滤芯",
        "brand": "奥迪",
        "category_id": 23,
        "category_name": "滤芯",
        "quantity": 10,
        "avg_price": 120.5,
        "remark": ""
      }
    ],
    "created_at": 1732100000,
    "updated_at": 1732103600
  }
  ```
- Redis 有效期：3 天，提交/删除后即时清除
- 提交时才生成正式 `order_no` 并落表，第一版业务直接进入状态 3（询价中）

**设计说明：**

- `store_name` 和 `creator_name` 不在主表存储，查询时通过关联用户表和门店表获取
- `total_items`（明细条数）不在主表存储，通过统计明细表获取
- 各阶段时间信息通过状态流转记录表（tb_purchase_order_status_log）记录
- 索引仅保留主键和 `order_no` 唯一索引，其他查询条件通过应用层处理
- `expected_delivery_date` 虽以 `datetime` 存储，但仅使用 `YYYY-MM-DD` 语义

**字段说明：**

- `ctime`：记录正式落库（提交草稿）时间
- `expected_delivery_date`：期望到货日期（数据库 `datetime`，业务按日期处理）
- `inquiry_deadline`：询价截止时间（业务字段）
- 明细条数通过统计 `tb_purchase_order_item` 表获取
- 其他流程时间（提交时间、审核时间、下单时间等）通过状态流转表记录

---

## 3. 采购单状态流转记录表

### 3.1 表名

`tb_purchase_order_status_log`

### 3.2 表说明

记录采购单的状态变更历史，包括每次状态变更的时间、操作人、操作说明等信息。一个采购单可能有多条状态流转记录。

### 3.3 表结构

| 字段名 | 数据类型 | 是否为空 | 默认值 | 说明 |
| --- | --- | --- | --- | --- |
| id | bigint | NOT NULL | 自增 | 主键 ID |
| order_id | bigint | NOT NULL | 0 | 采购单主表 ID |
| order_no | bigint | NOT NULL | 0 | 采购单号（冗余字段，便于查询） |
| from_status | int | NOT NULL | 0 | 变更前状态 |
| to_status | int | NOT NULL | 0 | 变更后状态 |
| operator_id | bigint | NOT NULL | 0 | 操作人 ID |
| operator_name | varchar(30) | NOT NULL | '' | 操作人姓名（冗余字段） |
| remark | varchar(128) | NOT NULL | '' | 操作说明/备注 |
| ctime | datetime | NOT NULL | CURRENT_TIMESTAMP | 状态变更时间 |

### 3.4 索引设计

| 索引名称          | 索引类型 | 字段     | 说明         |
| ----------------- | -------- | -------- | ------------ |
| PRIMARY           | 主键     | id       | 主键索引     |
| idx_posl_order_no | 普通索引 | order_no | 采购单号查询 |

### 3.5 建表 SQL

```sql
CREATE TABLE `tb_purchase_order_status_log` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `order_id` bigint NOT NULL DEFAULT '0' COMMENT '采购单主表ID',
  `order_no` bigint NOT NULL DEFAULT '0' COMMENT '采购单号',
  `from_status` int NOT NULL DEFAULT '0' COMMENT '变更前状态',
  `to_status` int NOT NULL DEFAULT '0' COMMENT '变更后状态',
  `operator_id` bigint NOT NULL DEFAULT '0' COMMENT '操作人ID',
  `operator_name` varchar(30) NOT NULL DEFAULT '' COMMENT '操作人姓名',
  `remark` varchar(128) NOT NULL DEFAULT '' COMMENT '操作说明/备注',
  `ctime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '状态变更时间',
  PRIMARY KEY (`id`),
  KEY `idx_posl_order_no` (`order_no`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='采购单状态流转记录表';
```

### 3.6 字段说明补充

**状态流转记录规则：**

- 每次状态变更都需要记录一条日志
- `from_status` 和 `to_status` 记录状态变化
- 特殊情况：
  - 草稿创建时：`from_status = 0`, `to_status = 0`
  - 草稿提交时：`from_status = 0`, `to_status = 1`
  - 审核驳回时：`from_status = 1`, `to_status = 2`，需填写驳回原因到 `remark`
  - 价格审批驳回时：`from_status = 5`, `to_status = 6`，需填写驳回原因到 `remark`

**时间信息查询：**

通过查询此表可以获取采购单各阶段的时间：

- 提交时间：`to_status = 1` 的记录的 `ctime`
- 审核通过时间：`to_status = 3` 的记录的 `ctime`
- 询价发送时间：`to_status = 3` 且 `remark` 包含"系统自动发起询价"的记录
- 下单时间：`to_status = 7` 的记录的 `ctime`
- 到货确认时间：`to_status = 8` 的记录的 `ctime`

**操作人信息：**

- `operator_id` 和 `operator_name` 记录操作人信息
- 系统自动操作时，`operator_id` 可设置为 0，`operator_name` 设置为"系统"

**示例记录：**

| id | order_id | order_no | from_status | to_status | operator_id | operator_name | remark | ctime |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 1 | 1 | 10251121495060001 | 0 | 3 | 100 | 张三 | 采购员提交采购单（自动审核） | 2024-11-20 10:00:00 |
| 2 | 1 | 10251121495060001 | 3 | 3 | 0 | 系统 | 系统自动向 5 个供应商发送询价 | 2024-11-20 10:00:01 |
| 3 | 1 | 10251121495060001 | 3 | 4 | 0 | 系统 | 询价截止，3 个供应商已报价 | 2024-11-25 23:59:59 |
| 4 | 1 | 10251121495060001 | 4 | 7 | 100 | 张三 | 选择供应商 A，提交订单 | 2024-11-26 09:00:00 |
| 5 | 1 | 10251121495060001 | 7 | 8 | 100 | 张三 | 确认到货，实际到货日期：2024-11-30 | 2024-11-30 14:00:00 |

---

## 4. 采购单明细表

### 4.1 表名

`tb_purchase_order_item`

### 4.2 表说明

存储采购单中的商品明细信息，一个采购单包含多个明细条目。

### 4.3 表结构

| 字段名 | 数据类型 | 是否为空 | 默认值 | 说明 |
| --- | --- | --- | --- | --- |
| id | bigint | NOT NULL | 自增 | 主键 ID |
| order_id | bigint | NOT NULL | 0 | 采购单主表 ID |
| order_no | bigint | NOT NULL | 0 | 采购单号（冗余字段，便于查询） |
| sku_id | bigint | NOT NULL | 0 | 商品 SKU ID |
| product_name | varchar(200) | NOT NULL | - | 商品名称（冗余字段） |
| brand | varchar(50) | NOT NULL | - | 品牌名称（冗余字段） |
| category_id | bigint | NOT NULL | 0 | 商品分类 ID |
| category_name | varchar(100) | NULL | NULL | 商品分类名称（冗余字段） |
| quantity | int | NOT NULL | 0 | 采购数量 |
| avg_price | decimal(10,2) | NULL | NULL | 采购均价（从商品表获取，用于价格审批对比） |
| selected_supplier_id | bigint | NULL | NULL | 选中的供应商 ID（下单后填写） |
| selected_supplier_name | varchar(100) | NULL | NULL | 选中的供应商名称（下单后填写） |
| actual_price | decimal(10,2) | NULL | NULL | 实际成交单价（下单后填写） |
| actual_total_price | decimal(10,2) | NULL | NULL | 实际成交总价（下单后填写） |
| remark | varchar(128) | NOT NULL | '' | 明细备注 |
| is_deleted | tinyint | NOT NULL | 0 | 是否删除（0-未删除，1-已删除） |
| ctime | datetime | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| mtime | datetime | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 3.4 索引设计

| 索引名称         | 索引类型 | 字段     | 说明         |
| ---------------- | -------- | -------- | ------------ |
| PRIMARY          | 主键     | id       | 主键索引     |
| idx_poi_order_no | 普通索引 | order_no | 采购单号查询 |

### 3.5 建表 SQL

```sql
CREATE TABLE `tb_purchase_order_item` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `order_id` bigint NOT NULL DEFAULT '0' COMMENT '采购单主表ID',
  `order_no` bigint NOT NULL DEFAULT '0' COMMENT '采购单号',
  `sku_id` bigint NOT NULL DEFAULT '0' COMMENT '商品SKU ID',
  `product_name` varchar(200) NOT NULL COMMENT '商品名称',
  `brand` varchar(50) NOT NULL COMMENT '品牌名称',
  `category_id` bigint NOT NULL DEFAULT '0' COMMENT '商品分类ID',
  `category_name` varchar(100) DEFAULT NULL COMMENT '商品分类名称',
  `quantity` int NOT NULL DEFAULT '0' COMMENT '采购数量',
  `avg_price` decimal(10,2) DEFAULT NULL COMMENT '采购均价',
  `selected_supplier_id` bigint DEFAULT NULL COMMENT '选中的供应商ID',
  `selected_supplier_name` varchar(100) DEFAULT NULL COMMENT '选中的供应商名称',
  `actual_price` decimal(10,2) DEFAULT NULL COMMENT '实际成交单价',
  `actual_total_price` decimal(10,2) DEFAULT NULL COMMENT '实际成交总价',
  `remark` varchar(128) NOT NULL DEFAULT '' COMMENT '明细备注',
  `is_deleted` tinyint NOT NULL DEFAULT '0' COMMENT '是否删除',
  `ctime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `mtime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_poi_order_no` (`order_no`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='采购单明细表';
```

### 3.6 字段说明补充

**冗余字段设计：**

- `order_no`、`product_name`、`brand`、`category_name`、`selected_supplier_name` 等字段冗余存储
- 目的：减少多表关联查询，提升查询性能
- 维护：在主表数据变更时同步更新

**价格字段说明：**

- `avg_price`：从商品表获取的采购均价，用于价格审批时的对比基准
- `actual_price`：供应商实际报价的单价
- `actual_total_price`：实际成交总价 = `actual_price` × `quantity`

**选中供应商字段：**

- `selected_supplier_id`、`selected_supplier_name`：采购员比价后选中的供应商
- 下单前为空，下单时填写

---

## 5. 表关系说明

### 5.1 主从关系

```
tb_purchase_order (1) ----< (N) tb_purchase_order_status_log
tb_purchase_order (1) ----< (N) tb_purchase_order_item
```

- 一个采购单可以包含多个状态流转记录
- 一个采购单可以包含多个明细条目
- 通过 `order_id` 和 `order_no` 关联
- 删除采购单时，明细表数据也需要软删除（级联更新 `is_deleted`）
- 状态流转记录表不使用软删除，保留完整历史

### 5.2 关联关系图

```
                    ┌─────────────────────────┐
                    │  tb_purchase_order      │
                    │  (采购单主表)           │
                    ├─────────────────────────┤
                    │ id (PK)                 │
                    │ order_no (UK)           │
                    │ store_id                │
                    │ creator_id              │
                    │ status                  │
                    │ ...                     │
                    └─────────────────────────┘
                            │
              ┌─────────────┴─────────────┐
              │                           │
              │ 1:N                       │ 1:N
              │                           │
              ▼                           ▼
┌──────────────────────────────┐  ┌─────────────────────────┐
│ tb_purchase_order_status_log │  │  tb_purchase_order_item │
│ (状态流转记录表)             │  │  (采购单明细表)         │
├──────────────────────────────┤  ├─────────────────────────┤
│ id (PK)                      │  │ id (PK)                 │
│ order_id (FK)                │  │ order_id (FK)           │
│ order_no                     │  │ order_no                │
│ from_status                  │  │ sku_id                  │
│ to_status                    │  │ quantity                │
│ operator_id                  │  │ avg_price               │
│ ctime                   │  │ ...                     │
│ ...                          │  └─────────────────────────┘
└──────────────────────────────┘
```

---

## 6. 数据流转说明

### 6.1 草稿阶段（Redis）

**存储位置：** Redis（JSON 字符串）

**Key 格式：** `ajt:purchase:draft:{creator_id}:{store_id}`

**存储内容示例：**

```json
{
  "store_id": 1,
  "creator_id": 100,
  "expected_delivery_date": "2024-12-01",
  "inquiry_deadline": "2024-11-25T23:59:59+08:00",
  "remark": "备注信息",
  "order_type": 1,
  "items": [
    {
      "sku_id": "80000001",
      "product_name": "机油滤清器",
      "brand": "奥迪",
      "category_id": 23,
      "category_name": "滤芯",
      "quantity": 10,
      "avg_price": 50.0,
      "remark": ""
    }
  ],
  "created_at": 1732100000,
  "updated_at": 1732103600
}
```

**TTL：** 3 天（259200 秒），提交或删除后即时清理；同一用户+门店仅允许保存一份草稿。

### 6.2 提交后（MySQL）

**操作流程：**

1. 从 Redis 读取草稿数据并校验 `store_id`、items 等字段
2. 调用 `IdGenerator` 生成正式采购单号（int64）
3. 插入 `tb_purchase_order`，状态直接设置为 3（询价中，第一版自动审核通过）
4. 批量插入 `tb_purchase_order_item`
5. 写入状态流转记录：`from_status=0`、`to_status=3`、`remark=自动审核通过`
6. 若存在 `inquiry_deadline`，同步触发询价单生成
7. 删除 Redis 草稿（`ajt:purchase:draft:{creator_id}:{store_id}`）

### 6.3 状态流转记录规则

**每次状态变更都需记录：**

1. 草稿提交：第一版直接自动审核通过，记录 `0 -> 3`（remark：“系统自动审核通过”）。若未来启用人工审核，则记录 `0 -> 1`。
2. 审核通过（仅在启用人工审核时）：`1 -> 3`。
3. 系统发送询价：`3 -> 3`，备注记录发送的供应商/数量。
4. 审核驳回（启用人工审核时）：`1 -> 2`，备注填写驳回原因。
5. 供应商报价完成：记录 `3 -> 4`。
6. 提交价格审批：`4 -> 5`。
7. 价格审批通过：`5 -> 4`。
8. 价格审批驳回：`5 -> 6`，备注填写驳回原因。
9. 下单：`4 -> 7`。
10. 到货确认：`7 -> 8`，备注记录实际到货信息。

---

## 7. 查询示例

### 7.1 查询采购单及其明细

```sql
-- 查询单个采购单及其明细
SELECT
  po.*,
  poi.id AS item_id,
  poi.sku_id,
  poi.product_name,
  poi.brand,
  poi.quantity,
  poi.avg_price,
  poi.actual_price
FROM tb_purchase_order po
LEFT JOIN tb_purchase_order_item poi ON po.id = poi.order_id AND poi.is_deleted = 0
WHERE po.order_no = '10251121495060001'
  AND po.is_deleted = 0;
```

### 7.2 查询采购单的状态流转记录

```sql
-- 查询单个采购单的完整状态流转历史
SELECT
  id,
  from_status,
  to_status,
  operator_name,
  remark,
  ctime
FROM tb_purchase_order_status_log
WHERE order_no = '10251121495060001'
ORDER BY ctime ASC;
```

### 7.3 查询采购单及其关键时间节点

```sql
-- 查询采购单及其提交时间、下单时间、到货时间
SELECT
  po.order_no,
  po.status,
  po.ctime AS created_time,
  (SELECT ctime FROM tb_purchase_order_status_log
   WHERE order_id = po.id AND to_status = 1 LIMIT 1) AS submit_time,
  (SELECT ctime FROM tb_purchase_order_status_log
   WHERE order_id = po.id AND to_status = 3 LIMIT 1) AS approval_time,
  (SELECT ctime FROM tb_purchase_order_status_log
   WHERE order_id = po.id AND to_status = 7 LIMIT 1) AS order_placed_time,
  (SELECT ctime FROM tb_purchase_order_status_log
   WHERE order_id = po.id AND to_status = 8 LIMIT 1) AS delivery_confirmed_time
FROM tb_purchase_order po
WHERE po.order_no = '10251121495060001'
  AND po.is_deleted = 0;
```

### 7.4 查询指定门店的采购单

```sql
-- 查询门店的所有采购单（不含草稿）及明细条数
SELECT
  po.order_no,
  po.expected_delivery_date,
  po.status,
  COUNT(poi.id) AS total_items,
  (SELECT ctime FROM tb_purchase_order_status_log
   WHERE order_id = po.id AND to_status = 1 LIMIT 1) AS submit_time
FROM tb_purchase_order po
LEFT JOIN tb_purchase_order_item poi ON po.id = poi.order_id AND poi.is_deleted = 0
WHERE po.store_id = 1
  AND po.status > 0
  AND po.is_deleted = 0
GROUP BY po.id, po.order_no, po.expected_delivery_date, po.status
ORDER BY po.ctime DESC
LIMIT 20;
```

### 7.5 查询采购员的草稿列表

```sql
-- 草稿只应存在于 Redis，此查询仅用于排查“误落库”的草稿记录
SELECT
  po.order_no,
  s.store_name,
  po.expected_delivery_date,
  COUNT(poi.id) AS total_items,
  po.ctime
FROM tb_purchase_order po
JOIN tb_internal_store s ON s.id = po.store_id
LEFT JOIN tb_purchase_order_item poi ON poi.order_id = po.id AND poi.is_deleted = 0
WHERE po.creator_id = 100
  AND po.status = 0
  AND po.is_deleted = 0
GROUP BY po.order_no, s.store_name, po.expected_delivery_date, po.ctime
ORDER BY po.ctime DESC;
```

### 7.6 统计查询

```sql
-- 统计各状态的采购单数量
SELECT
  po.status,
  COUNT(DISTINCT po.id) AS order_count,
  COUNT(poi.id) AS total_items
FROM tb_purchase_order po
LEFT JOIN tb_purchase_order_item poi ON po.id = poi.order_id AND poi.is_deleted = 0
WHERE po.is_deleted = 0
  AND po.status > 0
GROUP BY po.status;
```

### 7.7 查询采购单的平均处理时长

```sql
-- 统计从提交到下单的平均处理时长（天）
SELECT
  AVG(TIMESTAMPDIFF(DAY, submit_log.ctime, order_log.ctime)) AS avg_days
FROM tb_purchase_order po
JOIN tb_purchase_order_status_log submit_log
  ON po.id = submit_log.order_id AND submit_log.to_status = 1
JOIN tb_purchase_order_status_log order_log
  ON po.id = order_log.order_id AND order_log.to_status = 7
WHERE po.status = 7
  AND po.is_deleted = 0;
```

---

## 8. 性能优化建议

### 8.1 索引优化

- 主表仅保留主键和 `order_no` 唯一索引，简化索引结构
- 根据实际查询场景，如发现性能瓶颈，可考虑添加：
  - `idx_po_store_id`：门店维度查询
  - `idx_po_creator_id`：创建人维度查询
  - `idx_po_status`：状态维度查询
  - `idx_po_created_at`：时间范围查询
- 定期分析慢查询日志，按需添加索引

### 8.2 分区策略

当数据量达到百万级别时，可考虑按时间分区：

```sql
-- 按月分区示例（需要在建表时设置）
PARTITION BY RANGE (TO_DAYS(ctime)) (
  PARTITION p202411 VALUES LESS THAN (TO_DAYS('2024-12-01')),
  PARTITION p202412 VALUES LESS THAN (TO_DAYS('2025-01-01')),
  ...
);
```

### 8.3 数据归档

- 状态为"已到货"且超过 1 年的采购单，可归档到历史表
- 保留最近 2 年的热数据在主表中

### 8.4 状态流转表优化

- 状态流转表数据量会持续增长，建议定期归档超过 1 年的历史记录
- 为高频查询场景（如查询最新状态变更）建立组合索引
- 考虑按 `order_id` 分区，提升查询性能

---

## 9. 数据完整性约束

### 9.1 应用层约束

- 采购单号必须全局唯一
- 明细表的 `order_id` 必须在主表中存在
- 状态流转表的 `order_id` 必须在主表中存在
- 删除采购单时，必须同时软删除所有明细
- 状态流转记录不允许删除（保留完整历史）
- `actual_total_price` = `actual_price` × `quantity`

### 9.2 业务规则

- 草稿状态（status=0）的数据不应存在于 MySQL 中
- 状态流转必须按照状态枚举定义的顺序
- 每次状态变更都必须记录到状态流转表
- 已到货的采购单不允许修改
- 驳回操作必须填写驳回原因到状态流转表的 `remark` 字段

---

## 10. 变更记录

| 版本 | 日期       | 变更内容 | 变更人       |
| ---- | ---------- | -------- | ------------ |
| 1.0  | 2024-11-20 | 初始版本 | 系统架构团队 |

---

**文档结束**
